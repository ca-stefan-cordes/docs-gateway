= Publishing an API with Multiple Upstream Services in Local Mode
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../assets/images

include::partial$task-traffic-management.adoc[tags=intro]

== Configuring Traffic Management Parameters

Traffic management in Local Mode is configured as a `PolicyBinding` YAML configuration resource. Each `route-weighted` resource defines a single a route. To add additional routes, you can add multiple `route-weighted` resources.





[source,yaml]
----
apiVersion: gateway.mulesoft.com/v1alpha1
kind: PolicyBinding
metadata:
  name: <value>
spec:
  targetRef:
    name: <value>
  policyRef:
    name: route-weighted
  config:
    routes:
    - weight: <numerical-value> # max_value=100, min_value=1
      destinationPath: /posts/
      destinationRef:
        name: jsonplaceholder-v1
    - weight: 50 # this is not a % value, It would have the same behaviour if both weights are configured with same weights. Ej: 5 and 5, total weight = 10, means each one has 50% of the total weight
      destinationPath: /todos/
      destinationRef:
        name: jsonplaceholder-v2
  rules:
   - path: (.*)
     methods: GET|POST
     headers:
       x-test: true
     host: test.com
----

|===
|Parameter | Required or Optional | Description

| `spec.targetRef.name`
| Required
| The API instance identifier to which the policy is bound to.

| `spec.policyRef.name`
| Required
| Policy name,

| `spec.config`
| Required
| Traffic management configuration values.

| `spec.config.routes`
| Minimun 1 Route +
Maximum 10 Routes
| Route configuration values

| `spec.config.routes.weight`
| Required


Minimun 1 Route +
Maximum 10 Routes
| Route configuration values

- weight: 50 # max_value=100, min_value=1
      destinationPath: /posts/
      destinationRef:
        name: jsonplaceholder-v1



| `basicAuth.username`
| Required when `basicAuth` configured
| Authentication username

| `basicAuth.Password`
| Required when `basicAuth` configured
| Authentication password

| `noProxy`
| Optional
| Array containing domain names to communicate to without using the forward proxy
|===



Publish an API running behind Flex Gateway in Local Mode, modifying YAML configuration data by the following method:

* Linux and Docker: `.yaml` files

The following procedures demonstrate applying a simple YAML configuration for an unsecured API with multiple upstream services.

[cols="1a,1a,1a"]
|===
|image:install-linux-logo.png[20%,20%,xref="#linux"]
|image:install-docker-logo.png[25%,25%,xref="docker"]
|image:install-kubernetes-logo.png[20%,20%,xref="kubernetes"]

|<<linux>>
|<<docker>>
|<<kubernetes>>
|===

== Configuring Forward Proxy Parameters

[source,yaml]
----
apiVersion: gateway.mulesoft.com/v1alpha1
kind: Configuration
metadata:
  name: forward-proxy
spec:
  forwardProxy: 
    https: 
      address: http://proxy:8888 
      basicAuth: 
        username: <string> 
        password: <string> 
    noProxy: 
       - fluentd
       - .svc.cluster.local

----

|===
|Parameter | Required or Optional | Description

| `https.address`
| required
| Proxy adddress

| `basicAuth`
| Optional
| Supplies the authentication username and password

| `basicAuth.username`
| Required when `basicAuth` configured
| Authentication username

| `basicAuth.Password`
| Required when `basicAuth` configured
| Authentication password

| `noProxy`
| Optional
| Array containing domain names to communicate to without using the forward proxy
|===
== Publish an API Running Behind Flex Gateway on Linux 

=== Before You Begin

Before getting started, ensure that you have:

* Flex Gateway installed and running in local mode. See xref:flex-install.adoc[] for more information about installing and running the gateway. 
* Your upstream service URLs. The following example refers to fictional `products-api` and `users-api` services, but you can specify your own API name in `metadata.name` and your service details in `spec.services`.

=== Publish an API

. Create a configuration file with a `.yaml` file extension:
.. Give the file a custom name.
.. Save the file in the Flex Gateway configuration directory `/etc/mulesoft/flex-gateway/conf.d/custom`. This directory can contain multiple configuration files.

. Copy and paste the following `API Instance` and `PolicyBiding` resources into the file, substituting your values where indicated:
+
----
apiVersion: gateway.mulesoft.com/v1alpha1
kind: ApiInstance
metadata:
  name: json-http
spec:
  address: http://0.0.0.0:8080/json
​
---
​
apiVersion: gateway.mulesoft.com/v1alpha1
kind: PolicyBinding
metadata:
  name: weight-routing-test
spec:
  targetRef:
    name: json-http
  policyRef:
    name: route-weighted
  config:
    routes:
    - weight: 50
      destinationPath: /posts/
      destinationRef:
        name: products-api
    - weight: 50
      destinationPath: /todos/
      destinationRef:
        name: users-api
  rules:
   - path: (.*)
     methods: GET|POST
     headers:
       x-test: true
     host: test.com



apiVersion: gateway.mulesoft.com/v1alpha1
kind: ApiInstance
metadata:
  name: products-users-api
spec:
  address: http://0.0.0.0:8080
  services:
    products:
      address: https://<your products URL>:<your port>/
      routes:
        - rules:
            - path: /products(/.*)
            - path: /products-featured(/.*)
          config:
            destinationPath: /api            
    users:
      address: https://<your users URL>:<your port>/
      routes:
        - rules:
            - path: /api/users(/.*)
----

. Save the file. The gateway automatically refreshes the configuration.
+
. View the logs by executing the following command:
+
----
journalctl -u flex-gateway-*
----
+
The response looks something like this: 
+
----
[agent][info] Generating config
[agent][info] Gateway default/18b4e890fe7d: Adding ApiInstance default/products-users-api http://0.0.0.0:8080
[agent][info] Gateway default/18b4e890fe7d: Adding Route: &{host: path:/api/products(/.*) methods: headerConditions:[] profile:0xc0030529f0} => {Kind:Service Name:products-users-api-products Namespace:default}
[agent][info] Gateway default/18b4e890fe7d: Adding Route: &{host: path:/api/users(/.*) methods: headerConditions:[] profile:0xc0030529f0} => {Kind:Service Name:products-users-api-users Namespace:default}
[agent][info] Gateway default/18b4e890fe7d: Adding Policy default/envoy.filters.http.router
[agent][info] Gateway default/18b4e890fe7d: Adding Service default/monitoring_metrics http://0.0.0.0:9881
[agent][debug] generating service monitoring_metrics.default.svc hostname: 0.0.0.0 port: 9881
[agent][info] Gateway default/18b4e890fe7d: Adding Service default/products-users-api-products https://<your products URL>:<your port>/
[agent][info] Gateway default/18b4e890fe7d: Adding Service default/products-users-api-users https://<your users URL>:<your port>/
[agent][debug] generating service products-users-api-products.default.svc hostname: <your products URL> port: <your port>
[agent][debug] generating service products-users-api-users.default.svc hostname: <your users URL> port: <your port>
[agent][info] Writing envoy bootstrap configuration to /tmp/envoy.json
[envoy][info] cds: add 2 cluster(s), remove 2 cluster(s)
[envoy][info] cds: added/updated 1 cluster(s), skipped 1 unmodified cluster(s)
----

An API with multiple upstream services is now running behind Flex Gateway.

== Publish an API Running Behind Flex Gateway in a Docker Container 

=== Before You Begin

* Flex Gateway downloaded. See xref:flex-install.adoc[] for more information. 
* Flex Gateway registered and running in Local Mode. See xref:flex-local-reg-run.adoc[Register and Run in Local Mode] for more information. 
* Your upstream service URLs. The following example refers to fictional `products-api` and `users-api` services, but you can specify your own API name in `metadata.name` and your service details in `spec.services`.

=== Publish an API

. Open a terminal and navigate to the directory that will contain your Flex Gateway configuration files. This directory was specified when you started Flex Gateway.

. Create a configuration file with a `.yaml` file extension:
.. Give the file a custom name.
.. Save the file.

. Copy and paste the following YAML snippet into the file, substituting your values where indicated: 
+
----
apiVersion: gateway.mulesoft.com/v1alpha1
kind: ApiInstance
metadata:
  name: products-users-api
spec:
  address: http://0.0.0.0:8080
  services:
    products:
      address: https://<your products URL>:<your port>/
      routes:
        - rules:
            - path: /api/products(/.*)
            - path: /api/products-featured(/.*)
          config:
            destinationPath: /api            
    users:
      address: https://<your users URL>:<your port>/
      routes:
        - rules:
            - path: /api/users(/.*)
----

. Save the file. The gateway automatically refreshes the configuration.

. View the Docker container logs, which look something like this: 
+
----
[agent][info] Generating config
[agent][info] Gateway default/18b4e890fe7d: Adding ApiInstance default/products-users-api http://0.0.0.0:8080
[agent][info] Gateway default/18b4e890fe7d: Adding Route: &{host: path:/api/products(/.*) methods: headerConditions:[] profile:0xc0030529f0} => {Kind:Service Name:products-users-api-products Namespace:default}
[agent][info] Gateway default/18b4e890fe7d: Adding Route: &{host: path:/api/users(/.*) methods: headerConditions:[] profile:0xc0030529f0} => {Kind:Service Name:products-users-api-users Namespace:default}
[agent][info] Gateway default/18b4e890fe7d: Adding Policy default/envoy.filters.http.router
[agent][info] Gateway default/18b4e890fe7d: Adding Service default/monitoring_metrics http://0.0.0.0:9881
[agent][debug] generating service monitoring_metrics.default.svc hostname: 0.0.0.0 port: 9881
[agent][info] Gateway default/18b4e890fe7d: Adding Service default/products-users-api-products https://<your products URL>:<your port>/
[agent][info] Gateway default/18b4e890fe7d: Adding Service default/products-users-api-users https://<your users URL>:<your port>/
[agent][debug] generating service products-users-api-products.default.svc hostname: <your products URL> port: <your port>
[agent][debug] generating service products-users-api-users.default.svc hostname: <your users URL> port: <your port>
[agent][info] Writing envoy bootstrap configuration to /tmp/envoy.json
[envoy][info] cds: add 2 cluster(s), remove 2 cluster(s)
[envoy][info] cds: added/updated 1 cluster(s), skipped 1 unmodified cluster(s)
----

An API with multiple upstream services is now running behind Flex Gateway.