= Traffic Management for Multiple Upstream Services Policy
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../assets/images
:keywords: route weight, traffic management, multiple upstream services

[%autowidth.spread,cols="a,a"]
|===
>s| Policy Name | Traffic Management for Multiple Upstream Services
>s|Summary      | Manages API instance traffic to multiple upstream services from a single consumer endpoint
>s|Category | Security
>s| First Flex Gateway version available | v1.5.0
.4+>.^s| Returned Status Codes | No return codes exist for this policy.
[%autowidth.spread,cols="a,a"]
|
|===

[NOTE]
====
The following document applies only to Flex Gateway running in Local Mode. To configure multiple upstreams for Flex Gateway running in Connected Mode, see xref:api-manager::create-instance-task-flex.adoc#[traffic-management].
====

== Summary

Flex Gateway running in Local Mode supports API instances that expose multiple upstream services through a single consumer endpoint.

Flex Gateway manages traffic by using different routes with defined rulesets and route order to direct traffic to different sets of upstream services. Each API instance supports multiple routes that can each direct traffic to multiple upstream services.

Traffic management in Local Mode is configured as a `PolicyBinding` YAML configuration resource. Each `route-weighted` resource defines a single a route. To add additional routes, you can add multiple `route-weighted`.

== Configuring Policy Parameters

Refer to the following policy definition and table of parameters:

----
policyRef:
    name: route-weighted
  config:
    routes:
    - weight: <numerical-value> # max_value=100, min_value=1
      destinationPath: /posts/
      destinationRef:
        name: jsonplaceholder-v1
  rules:
   - path: (.*)
     methods: GET|POST
     headers:
       x-test: true
     host: test.com
----

[%header%autowidth.spread,cols="a,a,a,a"]
|===
| Parameter | Required or Optional | Default Value | Description

| `routes`
| Required
| Empty
| An array of API upstream services +
At least one upstream is required.

| `routes.weight`
| Required
| N/A
| The weight of total requests sent to this upstream. The percentage of traffic sent to that upstream is the upstream's weight divided by total weight of all upstream. For example, if there are two upstream with weight `1`, each upstream receives 50% of the traffic to that route.

| `routes.destinationPath`
| Required
| N/A
| Base path of the upstream service

| `routes.destinationRef.name`
| Required
| N/A
| Name of the upstream service as defined in the `Service` configuration resource

| `rules`
| Optional
| Empty
| An array of rulesets for this route +
Each route can support multiple rulesets.

| `rules.path`
| Optional
| Empty
| Defines the request path the route can service +
You can only define one â€œURI Template Regex" path for each ruleset. Only requests with the defined path are sent to this route.

| `rules.methods`
| Optional
| Empty
| An array defining the types of request methods the route can service +
You can select multiple methods for each ruleset. Only requests that are one of the defined methods are directed to this route.

| `rules.headers`
| Optional
| Empty
| An array defining request headers and a `true` or `false` value specifying if the header is present +
Only requests that meet all the specified header requirements are sent to this route. Additional headers present in the request that are not specifically defined in the rules are ignored.

| `rules.host`
| Optional
| Empty
| Defines the request host URL the route can service +
You can only define one host URL for each ruleset. Only requests made from the defined host are sent to this route.

|===

== How This Policy Works

The Traffic Management policy works by directing traffic to different sets of upstream services. 

For example, in the following diagram, different routes manage requests to flight information databases and to a customer service application. Route one has two upstream services defined directing 70% of requests to a stable database and 30% of requests to a beta database.

image:multiple-upstreams.png[]

To achieve this configuration, you must bind two `route-weighted` resources to the exposed API instance. One `route-weighted` resource directs traffic to the flight information database, and the other `route-weighted` resource directs traffic to the customer service application.

=== Upstream Services

You can use multiple upstream services in a single route to direct requests to similar services. For example, if you want to test the performance of a new beta upstream service without sending all traffic to the new service, you can direct half of the traffic to a stable upstream service and half to the new upstream service. 

What upstream service within the route each request is sent to is random and independent of any previous request. The `routes.weight` value defines the chance of a request being sent to a particular upstream service. The percentage of traffic sent to that upstream service is the upstream's `routes.weight` divided by total weight of all upstream services. For example, if there are two upstream services with weight `1`, each receives 50% of the traffic to that route. This is same as if both had a weight of `2`.

Since any upstream within a route could service any request, all upstream services within the same route must adhere to the same API contract.


=== Route Rules

You can direct requests to different routes using route rules. Only requests that meet the rule criteria for one of the rulesets are directed to that route. 

Rulesets refer to any combination of the four rules: `path`, `method`, `headers`, `host`. You can use multiple rulesets to support different combinations of rules.

All rules are optional. Not defining a value for a rule means that aspect of the request not considered. For example, not specifying a host means that the route can service any host given the request meets the other rules in the rule set. Not defining any rules means that the route can service every request.

=== Route Order

In addition to route rules, you can direct requests to different routes using policy ordering. 

To order policies, see xref:policies-reorder.adoc[]

Setting the policy order sets the order in which traffic is directed to the routes. Requests are sent to the first route where they meet the route rule criteria for one of the rulesets. Therefore, route ordering is very important when a request may meet the route rules of multiple routes. 

For example, in a configuration where route one has the `GET` method defined as a rule and route two has no route rules defined, all `GET` requests are sent to route one and all other requests are sent to route two. If the route order was reversed and route one had no route rules, Flex Gateway would direct all requests to route one before any `GET` requests could reach route two.  


== See Also
* xref:flex-conn-tls-config.adoc[]
* xref:flex-local-tls-config.adoc[]
* xref:policies-included-tls-outbound.adoc[]