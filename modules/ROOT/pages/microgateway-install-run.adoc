= Install and Run Flex Gateway
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../assets/images

Flex Gateway runs in many different environments, including Docker, Ubuntu, and Kubernetes (as an application and as an ingress controller). This document describes how to install and run Flex Gateway in each of these environments.

[cols="1,1,1,1"]
|===

|image:install-docker-logo.png[25%,25%,xref="microgateway-install-run.adoc#install-and-run-as-a-docker-container-image"]

|image:install-ubuntu-logo.png[20%,20%,xref="microgateway-install-run.adoc#install-and-run-as-an-ubuntu-service"]

|image:install-kubernetes-logo.png[20%,20%,xref="microgateway-install-run.adoc#install-and-run-as-a-kubernetes-application"]

|image:install-kubernetes-logo.png[20%,20%,xref="microgateway-install-run.adoc#install-and-run-as-a-kubernetes-ingress-controller"]

|xref:microgateway-install-run.adoc#install-and-run-as-a-docker-container-image[Install and Run as a Docker Container Image]

|xref:microgateway-install-run.adoc#install-and-run-as-an-ubuntu-service[Install and Run as an Ubuntu Service in a VM]

|xref:microgateway-install-run.adoc#install-and-run-as-a-kubernetes-application[Install and Run as a Kubernetes Application]

|xref:microgateway-install-run.adoc#install-and-run-as-a-kubernetes-ingress-controller[Install and Run as a Kubernetes Ingress Controller]

|===

== Install and Run as a Docker Container Image

A Docker container image is a package of software that includes everything needed to run an application. You install and run Flex Gateway as a container image in your local environment during application development - enabling you to test and iterate quickly within Continuous-Integration and Continuous Delivery (CI/CD) workflows. 

The following procedure demonstrates how to install and run a "containerized" Flex Gateway in your local environment.

=== Before You Begin

Installation requires a Docker-enabled environment with appropriate Docker permissions.

=== Procedure

. https://drive.google.com/file/d/1xR2kQqV5BUdIqk8LUbdW8LSdjlF2dP8P/view?usp=sharing[Download the Flex Gateway container image^].
. Copy the container image tar archive into a directory of your choice.
. Open a command line client and navigate to the directory containing the container image tar archive.
. Load ("install") the Flex Gateway container image by executing the following command:
+
----
docker load --input anypoint-flex-gateway.tar
----

. Verify the installation was successful by executing the following command: 
+
----
docker images
----
+
The Flex Gateway container image should appear in the resulting list: 
+
----
REPOSITORY                                TAG       IMAGE ID       CREATED        SIZE
mulesoft/anypoint-flex-gateway            latest    1c1fbdbf819b   9 days ago     279MB
----

. https://drive.google.com/file/d/1Uq1YA8UZCRCLhmg7-nMsUPjafNjFzAPQ/view?usp=sharing[Download the sample Flex Gateway configuration file^].
. Copy the sample configuration `.yaml` file into a directory of your choice (typically the same directory as the container image tar archive.)
. Run the Flex Gateway by executing the following command: 
+
----
docker run -it -p 8080:8080 -v /absolute/path/to/sample/config.yaml:/etc/peregrine/conf.d/custom/config.yaml mulesoft/anypoint-flex-gateway
----

. Verify that the container image is running successfully by executing the following command: 
+
----
docker ps
----
+
The Flex Gateway process should appear in the resulting list: 
+
----
CONTAINER ID   IMAGE                            COMMAND   CREATED      STATUS      PORTS                                       
c2a360f8c9ed   mulesoft/anypoint-flex-gateway   "/init"   8 days ago   Up 8 days   0.0.0.0:8080->8080/tcp, :::8080->8080/tcp 
----

== Install and Run as an Ubuntu Service

In addition to sandboxing Flex Gateway as a Docker container image, you can install and run Flex Gateway as an Ubuntu service. The Ubuntu instance is typically run virtually as a node in a virtual machine cluster, thereby guaranteeing that each virtual machine (with its running Flex Gateway) is standalone and encapsulated. 

The following procedure demonstrates how to install and run Flex Gateway as a service in an Ubuntu instance.

=== Procedure

. Retrieve the public package keys and add them to the Advanced Package Tool (APT) key server by executing the following command:
+ 
----
wget -qO- https://peregrine-repos.s3.us-west-2.amazonaws.com/ubuntu/pubkey.gpg | sudo apt-key add -
----

. Add the Flex Gateway package repository by storing the type of distribution archive (Debian), as well as the repository URL and Ubuntu distribution code name. Execute the following command: 
+
----
echo "deb https://peregrine-repos.s3.us-west-2.amazonaws.com/ubuntu $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/mulesoft.list
----

. Update the package list by executing the following command: 
+
----
sudo apt update
----

. Install the Flex Gateway package from the updated repository by executing the following command:
+
----
sudo apt install anypoint-flex-gateway
----

. Run the Flex Gateway by executing the following command:
+
----
sudo service anypoint-flex-gateway start
----

. Verify that the Flex Gateway service is running successfully by executing the following command: 
+
----
service --status-all
----
+
A list of all services displays. Locate the `anypoint-flex-gateway` service, which will be successfully running if the value of its `status` is `+`, as in the following:   
+
----
[ + ]  anypoint-flex-gateway
----

== Install and Run as a Kubernetes Application

You can install and run a containerized Flex Gateway on top of a Kubernetes cluster. To do so, you create a Kubernetes deployment configuration, which instructs Kubernetes how to create and update the Flex Gateway instance. Create this deployment configuration by using the Kubernetes command line interface, Kubectl.

The following procedure demonstrates how to install and run Flex Gateway as an application running in a Kubernetes cluster.

=== Before You Begin

Deploying Flex Gateway on Kubernetes requires a dedicated Kubernetes cluster that is provisioned and operational. 

=== Procedure

. Configure your network to support Flex Gateway on Kubernetes.
+
The following ports must be configured correctly:
+
[%header%autowidth.spread]
|===
| Port | Layer 4 Protocol | Layer 5 Protocol | Source | Destination | Description
| x | TCP | HTTPS | Internet | All nodes | Allow inbound requests to Flex Gateway
| x | TCP | x | All nodes | Internet | x
| x | TCP | x | All nodes | Internet | x
|===
+
The following hostnames must be configured correctly:
+
[%header,cols="4*a"]
|===
| Port | Protocol | Hostnames | Description
| x | x | x | x
| x | x | x | x
| x | x | x | x
|===

. Install Flex Gateway.
+
You can execute `docker load` and then `docker push` to a registry (you can host a private registry in Kubernetes or use a public one).

. After the installation has completed, insert the Mule license key.
+
.. Base64 encode the new Mule `.lic` license file provided by MuleSoft:
+
* On MacOS, run the following command:
+
----
base64 -b0 license.lic
----
+
* On Unix, run the following command:
+
----
base64 -w0 license.lic
----
+
* On Windows, a shell terminal emulator (such as cygwin) or access to a Unix-based computer is required.
+
... Transfer to your Unix environment if necessary.
... Run the following command to Base64 encode the license key:
+
----
base64 -w0 license.lic
----

.. Insert the Mule license key:
+
----
<command> apply mule-license BASE64_ENCODED_LICENSE
----

.. To verify the Mule license key has applied correctly, run:
+
----
<command> get mule-license
----

. Run Flex Gateway:
+
----
kubectl create deployment <...>
----

. Verify that the Flex Gateway service is running successfully. 
.. View the deployment: 
+
----
kubectl get deployments
----
+
The output is similar to: 
+
----
NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
anypoint-flex-gateway   1/1     1            1           1m
----
+
.. View the Pod: 
+
----
kubectl get pods <...>
----
+
The output is similar to: 
+
----
NAME                                     READY     STATUS    RESTARTS   AGE
anypoint-flex-gateway-5f76cf6ccf-br9b5   1/1       Running   0          1m
----


== Install and Run as a Kubernetes Ingress Controller

