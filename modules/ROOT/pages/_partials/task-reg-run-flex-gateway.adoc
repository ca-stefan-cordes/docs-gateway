// partial for registering in connected mode with a username and password or connected app in a Docker container or as a Linux service
// tag::heading-conn-username[]
= Registering and Running in Connected Mode with a Username and Password
// end::heading-conn-username[]
// tag::heading-conn-app[]
= Registering and Running in Connected Mode with a Connected App
// end::heading-conn-app[]
// tag::page-metadata[]
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../assets/images
// end::page-metadata[]

// tag::icon-selection-conn-username[]

[cols="1a,1a"]
|===
|image:install-docker-logo.png[25%,25%,xref="flex-conn-register-run-up.adoc#register-and-run-with-a-username-and-password-in-a-docker-container"]
|image:install-linux-logo.png[20%,20%,xref="flex-conn-reg-run-up.adoc#register-and-run-with-a-username-and-password-as-a-linux-service"]

|xref:flex-conn-reg-run-up.adoc#register-and-run-with-a-username-and-password-in-a-docker-container[Register and Run with a Username and Password in a Docker Container]
|xref:flex-conn-reg-run-up.adoc#register-and-run-with-a-username-and-password-as-a-linux-service[Register and Run with a Username and Password as a Linux Service]
|===

// end::icon-selection-conn-username[]

// tag::icon-selection-conn-app[]

[cols="1a,1a"]
|===
|image:install-docker-logo.png[25%,25%,xref="flex-conn-reg-run-app.adoc#register-and-run-with-a-connected-app-in-a-docker-container"]
|image:install-linux-logo.png[20%,20%,xref="flex-conn-reg-run-app.adoc#register-and-run-with-a-connected-app-as-a-linux-service"]

|xref:flex-conn-reg-run-app.adoc#register-and-run-with-a-connected-app-in-a-docker-container[Register and Run with a Connected App in a Docker Container]
|xref:flex-conn-reg-run-app.adoc#register-and-run-with-a-connected-app-as-a-linux-service[Register and Run with a Connected App as a Linux Service]
|===

// end::icon-selection-conn-app[]

// tag::prerequisites-heading[]

== Before You Begin
// end::prerequisites-heading[]
// tag::prerequisites-conn-app[]
Before registering Flex Gateway, you must complete the following tasks: 

* link:https://docs.mulesoft.com/service-mesh/1.2/obtain-connected-apps-credentials[Configure a Connected App]
** Include the following scopes:
*** Add Gateways
*** Read Gateways
*** Manage Servers
*** Read Severs
** Save the *Id* and *Secret* of the Connected app you configure.

// end::prerequisites-conn-app[]
// tag::prerequisites[]

* xref:flex-install.adoc[Install a Flex Gateway]
* Collect the following information from your Anypoint Platform instance: 
** *Organization ID* for the organization where you want to run Flex Gateway.
+
See link:https://docs.mulesoft.com/access-management/organization#find-your-organization-id[Find your Organization ID] for more information on how to find your Organization ID.
** *Environment ID* for the environment where you want to run Flex Gateway.
+
See xref:api-manager::latest-overview-concept#what-api-manager-looks-like[What API Manager Looks Like]
for more information on how to find your Environment ID.

// end::prerequisites[]
// tag::prerequisites-conn-user[]

** *Username* and *Password* of a user with _Admin_ permissions for Runtime Manager

// end::prerequisites-conn-user[]
// tag::conn-user-docker-heading[]
== Register and Run with a Username and Password in a Docker Container
// end::conn-user-docker-heading[]
// tag::conn-app-docker-heading[]
== Register and Run with a Connected App in a Docker Container
// end::conn-app-docker-heading[]
// tag::conn-user-linux-heading[]
== Register and Run with a Username and Password as a Linux Service
// end::conn-user-linux-heading[]
// tag::conn-app-linux-heading[]
== Register and Run with a Connected App as a Linux Service
// end::conn-app-linux-heading[]
// tag::conn-reg-command-intro[]
To register a Flex Gateway with Anypoint Platform you must enter the registration
command and then the start command. Each command includes information specific
to your Anypoint Platform instance and *must be edited before* executing.

=== Replace Sample Content

Before executing the registration command, replace the following sample content with your own:

// end::conn-reg-command-intro[] 
// tag::conn-user-replace-content[]

* `--username` = the username for an Anypoint Platform user with _Admin_ permissions for Runtime Manager
* `--password` = the password for an Anypoint Platform user with _Admin_ permissions for Runtime Manager
// end::conn-user-replace-content[]
// tag::conn-app-replace-content[]

* `--client-id` = the Id for the Connected App you configured in Access Management
* `--client-secret` = the Secret for the Connected App you configured in Access Management

// end::conn-app-replace-content[]
// tag::conn-replace-content[]

* `--environment` = the Environment Id for the environment in Anypoint Platform where you want the Flex Gateway to run
* `--organization` = your Organization ID in Anypoint Platform
* `--anypoint-url` = your Anypoint Platform instance URL 
* `my-gateway` = the name you want to assign to this Flex Gateway instance

// end::conn-replace-content[]
// tag::conn-reg-command-heading[]

=== Registration Command

After replacing the sample content, register your Flex Gateway by executing the following command: 

// end::conn-reg-command-heading[]
// tag::conn-user-docker-reg-command[]

[source,ssh,subs=attributes+]
----
docker run --entrypoint -w /registration "$(pwd)":/registration mulesoft/flex-gateway:{gateway-ver-var} \
flexctl register -v \
--username=john \
--password=doe \
--environment=334f8328-1355-4ad6-961d-1930a3ada25b \
--organization=40223f70-02d1-4027-910f-ebd662a7ee54 \
--anypoint-url=https://devx.anypoint.mulesoft.com \
my-gateway
----
// end::conn-user-docker-reg-command[]
// tag::conn-app-docker-reg-command[]
[source,ssh,subs=attributes+]
----
docker run --entrypoint -w /registration "$(pwd)":/registration mulesoft/flex-gateway:{gateway-ver-var} \
flexctl register -v \
--client-id=714e98tj0ik73f68c2mab2e952802342 \
--client-secret=e93rbbd85B479s2K7v88N5927T60s5D4 \
--environment=334f8328-1355-4ad6-961d-1930a3ada25b \
--organization=40223f70-02d1-4027-910f-ebd662a7ee54 \
--anypoint-url=https://devx.anypoint.mulesoft.com \
my-gateway
----
// end::conn-app-docker-reg-command[]
// tag::conn-user-linux-reg-command[]
[source]
----
flexctl -v register \
--username=john \
--password=doe \
--environment=334f8328-1355-4ad6-961d-1930a3ada25b \
--organization=40223f70-02d1-4027-910f-ebd662a7ee54 \
--anypoint-url=https://devx.anypoint.mulesoft.com \
my-gateway
----
// end::conn-user-linux-reg-command[]
// tag::conn-app-linux-reg-command[]
[source]
----
flexctl -v register \
--client-id=714e98tj0ik73f68c2mab2e952802342 \
--client-secret=e93rbbd85B479s2K7v88N5927T60s5D4 \
--environment=334f8328-1355-4ad6-961d-1930a3ada25b \
--organization=40223f70-02d1-4027-910f-ebd662a7ee54 \
--anypoint-url=https://devx.anypoint.mulesoft.com \
my-gateway
----
// end::conn-app-linux-reg-command[]
// tag::conn-after-reg[]
After you have executed the command, you should see your new Flex Gateway in Runtime Manager
after clicking *Flex Gateway* in the left navigation. 

The gateway's status is disconnected for now. You need to start the gateway to connect it.
// end::conn-after-reg[]
// tag::conn-start-command[]

=== Start Command

Before executing the start command below, replace the `.conf` file UUID with the UUID of the `.conf` file
in the folder where you have stored the Flex Gateway Docker image.

[source,ssh,subs=attributes+]
----
docker run --rm \
-v $(pwd)/:/etc/peregrine/rtm \
-p 8081:8081 \
-e MGW_RTM_ARM_AGENT_URL=wss://arm-mcm2-service.kdev.msap.io:443/agent \
-e MGW_DATASOURCE_RTM_ENABLED=true \
-e MGW_RTM_ARM_AGENT_CONFIG=/etc/peregrine/rtm/076ccaab-86a7-444d-8fbb-6620bafde086.conf \
mulesoft/flex-gateway:{gateway-ver-var}
----
// end::conn-start-command[]
// tag::conn-before-restart-command[]
You should see three new files where you executed the command, similar to the following: 

* `6eb79785-c2f0-4e06-b574-8a030a321d74.conf`
* `6eb79785-c2f0-4e06-b574-8a030a321d74.key`
* `6eb79785-c2f0-4e06-b574-8a030a321d74.pem`

Determine the path where these files live by using the command, `pwd`, then save the path and the UUID
of the file for later use. 

=== Create Configuration Folder and File

Before you start the gateway, you must create the create a directory using the following command: 

[source]
----
sudo mkdir /etc/systemd/system/peregrine-agent.service.d/
----

Afterwards, create a configuration file within that directory and name it `env.conf`.

Finally, edit the file with vim using the following command: 

[source]
----
sudo vi env.conf
----

// end::conn-before-restart-command[]
// tag::conn-config-content[]

=== Add Configuration Content

Add the content below to the `env.conf` file, after replacing the following sample content with your own: 

*  `/etc/peregrine/6eb79785-c2f0-4e06-b574-8a030a321d74.conf` = the path and UUID of the `.conf` file that was created when you registered the gateway
* `tb_ubuntu_1` = a name for your ubuntu instance

[source]
----
[Service]
Environment=MGW_RTM_ARM_AGENT_URL=wss://arm-mcm2-service.kdev.msap.io:443/agent
Environment=MGW_DATASOURCE_RTM_ENABLED=true
Environment=MGW_RTM_ARM_AGENT_CONFIG=/etc/peregrine/6eb79785-c2f0-4e06-b574-8a030a321d74.conf
Environment=MGW_NAME=tb_ubuntu_1
----

After you have added the content to the `env.conf` file, save the file with ESC + `:wq`.
// end::conn-config-content[]
// tag::restart-command[]

=== Restart Commands

First, restart Ubuntu with the following command: 

[source]
----
sudo systemctl daemon-reload
----

Then, restart Flex Gateway with the following command: 

[source]
----
sudo systemctl restart peregrine
----

// end::restart-command[]
// tag::conn-gateway-connected[]
Now if you check in Runtime Manager after clicking *Flex Gateway* in the left navigation, your gateway's status is connected. You may need to refresh the page.
// end::conn-gateway-connected[]
