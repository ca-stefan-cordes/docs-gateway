= Getting Started with Flex Gateway on a Kubernetes Cluster
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:version-helm: 3.0.0

Get started with Anypoint Flex Gateway on a Kubernetes cluster. Use Kubernetes, Docker, and Helm to install, register, and run Flex Gateway in Connected Mode. 

== Before You Begin

Before starting the procedures in this guide, ensure that you have the following:
 
* A username and password for your Anypoint Platform organization. If you don’t have Anypoint Platform yet, https://anypoint.mulesoft.com/login/signup[create a Trial organization^] on Anypoint Platform.
//TODO: VERIFY THAT Manage Servers and Read Servers permissions in Runtime Manager IS NO LONGER NEEDED

//TODO: verify Linux prerequisite and supported flavors
* A Linux or MacOS machine with an x86 processor. M1 and M2 processors are not supported.
+
include::partial$prerequisites.adoc[tag=intro]

** {empty}
include::partial$prerequisites.adoc[tag=amazon-linux]

** {empty}
include::partial$prerequisites.adoc[tag=centos]

** {empty}
include::partial$prerequisites.adoc[tag=debian]

** {empty}
include::partial$prerequisites.adoc[tag=red-hat]

** {empty}
include::partial$prerequisites.adoc[tag=ubuntu]

//docker prereq
* {empty}
include::partial$prerequisites.adoc[tag=docker]

//helm prereq
* {empty}
include::partial$prerequisites.adoc[tag=helm]

//kubectl prereq to select cluster prior to deployment
* {empty}
include::partial$prerequisites.adoc[tag=kubectl]

* A Kubernetes cluster into which you deploy a Flex Gateway replica. The cluster's host must be running. See <<k8-cluster>>. 

[[k8-cluster]]
=== Kubernetes Cluster Requirement

To complete the procedures in this guide, you must create a Kubernetes cluster or use an existing one for your Flex Gateway deployment. 
//TODO: DOES THE CLUSTER NEED ANY SPECIAL CHARACTERISTICS TO WORK WITH THE K8 STEPS IN RTM?

For this guide, MuleSoft recommends that you use a cluster that is hosted on one of the common cloud-based services, such as Amazon Elastic Kubernetes Service (EKS), Azure Kubernetes Service (AKS), or Google Kubernetes Engine (GKE).
//TODO: MULESOFT IS NOT TESTING ON A CLOUD-BASED SERVICE, SO IS IT A GOOD IDEA TO RECOMMEND USING  ONE?

//TODO: NOTE TO SELF: CREATE A CLUSTER WITH THIS PROCEDURE AND TEST STEPS:
If you have an Amazon Web Service (AWS) account, you can create an EKS cluster using https://docs.aws.amazon.com/eks/latest/userguide/create-cluster.html[Amazon EKS User Guide^]. The AWS Management Console provides one of the easier paths to creating the EKS cluster. The configuration requires an https://docs.aws.amazon.com/eks/latest/userguide/service_IAM_role.html#create-service-role[eksClusterRole^]. 

[NOTE]
To prevent potential timeout and connectivity errors when running procedures in this guide, avoid using simpler tools such as minikube to create a local cluster. 
//TODO: I SEEM TO BE GETTING THE SAME TIMEOUT ISSUE WITH MY EKS CLUSTER

== Step 1: Install Flex Gateway

Use Docker to install the Flex Gateway Docker image.

. Start your Docker application.
. Run the following command in a terminal window:
+
[source,docker,subs=attributes+]
----
docker pull mulesoft/flex-gateway:{gateway-ver-var}
----
+
When successful, this command returns a message similar to this one:
+
----
latest: Pulling from mulesoft/flex-gateway
Digest: sha256:e55555abcdefg1234567zxynwo33333fadjf
Status: Image is up to date for mulesoft/flex-gateway:latest
docker.io/mulesoft/flex-gateway:latest
----
+
Use `sudo` if you encounter file permission issues when running this command. 

== Step 2: Register Flex Gateway

Register the Flex Gateway image from a terminal window using a temporary token generated by Anypoint Runtime Manager. The procedure produces a `registration.yaml` file that you incorporate into your Helm chart when you deploy the Flex Gateway replica to your cluster and connect it to Anypoint Platform.

. From a terminal window, prepare a directory for a Flex Gateway registration file (`registration.yaml`).
.. Create a directory:
+
[source,mkdir]
----
mkdir flex-registration
----
.. Navigate to the new directory:
+
[source,cd]
----
cd flex-registration
----

. Log in to https://anypoint.mulesoft.com/login/[Anypoint Platform^] and select *Runtime Manager*.
. From Runtime Manager, locate the procedure for registering Flex Gateway:
.. Click *Flex Gateways* in the side navigation panel.
.. Click *Add Gateway*.
.. Select *Kubernetes*.
.. In the Kubernetes page, locate the command in the *Register your gateway* section:
+
image::gateway-quickstart-k8-add-gateway.png["Add registration code block from Add a Flex Gateway page"]
+
The highlighted command block includes your unique organization ID and a temporary token. 

. In your terminal window, copy the command block into your `/flex-registration` directory, and provide a name for your Flex Gateway replica before running the command: 
.. Replace `<gateway-name>`, located at the end of the command block, with a name of your choice, such as `my-gw`, for example:
+
----
docker run --entrypoint flexctl -u $UID \
>   -v "$(pwd)":/registration mulesoft/flex-gateway \
>   register --organization=_ORG_ID_HERE_ \
>   --token=_TOKEN_VALUE_HERE_ \
>   --output-directory=/registration \
>   --connected=true \
>   my-gw
----
+
Runtime Manager provides the required organization and token values.

.. Run the copied command.
+
When successful, the command produces a `registration.yaml` in your `/flex-registration` directory and provides the following message in your terminal window:
+
----
Starting registration, please be patient.
Registration completed, the configuration files were written 
in directory "/registration". For security, modify the file permissions 
to restrict production scenario access to the user running flex.
----
+
The `Registration completed` message in the terminal window refers to a `/registration` directory that resides within the Docker container.  
+
Use `sudo` if you encounter file permission issues when running this command. If your token expires before you run the command, a `400 Bad Request` error occurs, so you need to refresh the Runtime Manager page to generate a new token and run the modified command that appears on the page.


== Step 3: Create a Repository for the Helm Chart

Add and update a local repository that stores a Helm chart with your Flex Gateway replica's configuration. Note that you can get more information about the properties of the Helm chart for Flex Gateway in https://artifacthub.io/packages/helm/flex-gateway/flex-gateway[ArtifactHUB^].

. Add the Helm repo: 
+
[source,helm]
----
helm repo add flex-gateway https://flex-packages.anypoint.mulesoft.com/helm
----
+
The command either creates a repository or skips the repository creation process if one exists already:
+
* If the repository is new, the command returns the following message:
+
----
"flex-gateway" has been added to your repositories
----
+
* If the repository exists already, the command returns the following message:
+
----
"flex-gateway" already exists with the same configuration, skipping
----

. Run `helm repo up`.
+
The command returns the following message:
+
----
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "flex-gateway" chart repository
Update Complete. ⎈Happy Helming!⎈
----

[[deploy-flex]]
== Step 4: Deploy Flex Gateway

Use Helm to deploy a Flex Gateway container (replica) to a node in your cluster and connect it to Anypoint Platform. After deploying, you can use Runtime Manager to verify that the replica of your Flex Gateway is present and connected to Anypoint Platform. 

. From your terminal window, use `kubectl` to point to the cluster into which you plan to deploy the Flex Gateway replica, for example: 
+
.. List available clusters by running the following command in your terminal window:
+
[source,kubectl]
----
kubectl config get-contexts
----
.. From the list of contexts that returns, identify the cluster to host your Flex Gateway replica.
.. Run the following command, replacing `my-cluster` with the cluster you identified: 
+
[source,kubectl]
----
kubectl config use-context my-cluster
----
+
For more guidance, see <<use-cluster>>.

. Run the Helm command for deploying your Flex Gateway replica and connecting it to Anypoint Platform. 
+
[source,helm]
----
helm -n gateway upgrade -i --create-namespace \
--wait ingress flex-gateway/flex-gateway \ 
--set-file registration.content=registration.yaml
----
+
When successful, the following occurs:
+
* The command returns a message similar to the following one:
+
----
Release "ingress" has been upgraded. Happy Helming!
NAME: ingress
LAST DEPLOYED: Mon Mar 13 22:44:11 2023
NAMESPACE: gateway
STATUS: deployed
REVISION: 3
TEST SUITE: None
----

* A new Flex Gateway replica is running in your terminal window.
+
The replica runs until you stop the process or close the terminal window in which it is running.

. To locate the replica in Runtime Manager, select *Flex Gateways* from the side navigation panel.
+
The name of your registered Flex Gateway replica appears in the list of gateways.
+
image::gateway-quickstart-k8-my-gateway-rtm.png["Flex Gateway Replica my-gateway in Runtime Manager"]


//TODO: ADAPT STEP 5 AS NEEDED FOR K8, IN PROGRESS
[[create-api]]
== Step 5: Publish and Deploy a Simple API to Your Flex Gateway Replica

In Anypoint API Manager, create and deploy a simple API to your Flex Gateway replica. 

. Select *API Manager* from the Anypoint Platform menu.
+
Alternatively, from Runtime Manager, you can click the name of your new, connected Flex replica, click the three vertical dots at the end of the replica row, and click 

. Click *Add API*, followed by *Add new API*:
+
image::gateway-quickstart-add-new-api.png["Add new API page with Add new API selected",width=55%]
+
//TODO: WHY DOES THE UI CALL THE FLEX REPLICA A RUNTIME? 
. From the *Add API* page, select *Flex Gateway* as your runtime.
. Select your registered gateway in the *Select a gateway* section.
. Click *Next*.
+
The following screenshot of the *Add API* page highlights the specified options:
+
image::gateway-quickstart-select-gateway-for-api.png["Add API page with Flex Gateway Runtime and my-gw gateway selected",width=100%]

. Click *Create New API*.
. Specify an API name and select *HTTP API* as the asset type.
. Click *Next*.
. From the *Endpoint* page, enter the following in the *Implementation URI* field:
+
[source]
----
https://jsonplaceholder.typicode.com/
----
. Enter `8081` in the *Port* field.
. Click *Next*.
+
The following screenshot of the *Endpoint* page highlights the specified options.
+
image::gateway-quickstart-select-endpoint.png["Screenshot of 'Endpoint' page",width=100%]

. Click *Save & Deploy*.
+
Inside the API instance, all HTTP requests to `localhost` on port `8081` are proxied to the `jsonplaceholder` service.
. To test the API Instance, run the following command in a new terminal window:
+
[source,ssh]
----
curl -s -o /dev/null -w "%{http_code}\n" --request GET 'http://localhost:8081/'
----
+
The command executes a `GET` request to the API, and then prints the resulting `200` status code, indicating success.

To connect to an implementation on a remote host, you can use port `80`, get the external IP address for your API by using `kubectl -n gateway get services`, and using that IP in your `curl` command instead of using `localhost:8081`. For details, see <<connect-remote>>. 


//TODO: ADAPT STEP 6 AS NEEDED FOR K8, IN PROGRESS
== Step 6: Secure Your API Using the Basic Authentication Policy

Add a policy to your API.

. In *API Manager*, select *API Administration* from the side navigation panel.
. Select the name of the API that you created in <<create-api>>.
. Select *Policies* from the side navigation panel.
. In the *Policies* page, click *Add policy*.
+
The following screenshot of the *Policies* page highlights the specified options:
+
image::gateway-quickstart-add-policy.png["Add Policy page with Add policy button",width=65%]

. Select the *Basic Authentication - Simple* policy.
.. Click *Next*.
.. For *User Name*, enter `user`.
.. For *User Password*, enter `password`.
.. Click *Apply*.
+
The following figure highlights the options in the *Configure Basic Authentication - Simple policy* page:
+
image::gateway-quickstart-config-basic-auth.png["Configure Basic Authentication Policy page with User Password field selected",width=65%]

. To test the API Instance _without_ authentication, run the following `curl` command in the terminal window:
+
[source,ssh]
----
curl -s -o /dev/null -w "%{http_code}\n" --request GET 'http://localhost:8081/'
----
+
The command prints a resulting `401 (Unauthorized)` status code, because the request does not include the Authentication context.
. To test the API Instance _with_ authentication, run the following command in the terminal window:
+
[source,ssh]
----
curl -s -o /dev/null -w "%{http_code}\n" --request GET 'http://localhost:8081/' -u user:password
----
+
[NOTE]
The `user` and `password` parameters must match what was specified when you applied the policy via *API Manager*.
+
The command prints the resulting `200` status code, indicating success.


[[troubleshooting]]
== Troubleshooting
// TODO: TROUBLESHOOTING IN PROGRESS
If you encounter an error, look for a resolution here.

* If Docker is not started, a `docker` command returns an error message similar to this one:
+
----
Error response from daemon: Bad response from Docker engine
----
+
If you get this error, you need to start Docker.


* If you lose your connection to Anypoint Platform, the following error occurs:
+
----
[flexctl][error] reg facade call returned error response: HTTP/1.1 400 Bad Request
----
+
If you get this error, you need to log in to Anypoint Platform. 

* If your cluster is not running when you attempt to deploy Flex Gateway using `helm`, you need to start the cluster
+
----
Error: Kubernetes cluster unreachable: the server could not find the requested resource
----
+
You can check whether that your cluster host is running your cluster, for example:
+
[source,kubectl]
----
kubectl cluster-info
----
+
If the cluster is up, the command returns a result similar to this one:
+
----
Kubernetes control plane is running at https://34.30.50.119
GLBCDefaultBackend is running at https://34.30.50.119/api/v1/namespaces/kube-system/services/default-http-backend:http/proxy
KubeDNS is running at https://34.30.50.119/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
Metrics-server is running at https://34.30.50.119/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy
----
+
If the cluster is not up, the command returns a result similar to this one:
+
----
To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
error: the server doesn't have a resource type "services"
----

* If the Helm upgrade command fails to generate a Service resource of the LoadBalancer type, the command hangs for 5 minutes (due to the `--wait`) flag in the command and produces the following timeout error:
+
[source,error]
----
Error: UPGRADE FAILED: timed out waiting for the condition
----
+
This error typically means that your cluster is not generating the LoadBalancer. Such an issue can occur if you are using minikube, for example. Use one of the recommended cloud services to host your cluster. See <<k8-cluster>>.

[[use-cluster]]
=== Switching to the Cluster Intended for Your Flex Gateway Deployment

If you have multiple clusters, you need to make sure that you are using the correct one. To check, you can use `kubectl` to list and select the cluster to use.

For example, assume that you have a variety of clusters (`my-cluster`, `my-aks`, `my-gke`, `my-eks`). In this case, it is necessary to use the correct one before running the registration commands. 
+
Run `kubectl config get-contexts` to list the clusters, for example:
+
[source,kubectl]
----
kubectl config get-contexts
----
+
The command returns list of your clusters. This _example_ lists several clusters:
+
----
CURRENT   NAME          CLUSTER       AUTHINFO    NAMESPACE
          my-cluster    my-cluster                my-cluster1
          my-aks        my-aks                    my-aks
          my-gke        my-gke                    my-gke
          my-eks        my-eks                    my-eks
----

. Use the cluster into which you plan to install and register Flex Gateway.
+
This example selects the cluster `my-eks`: 
+
----
kubectl config use-context my-eks
----
+
The command returns a output like this:
+
----
Switched to context "my-eks".
----

See <<deploy-flex>> for the deployment procedure. 

[[connect-remote]]
=== Connect to an Implementation on a Remote Host



== Next Steps

* xref:flex-review-prerequisites.adoc[]
* xref:flex-install.adoc[]
* xref:flex-gateway-uninstall.adoc[]
* xref:flex-conn-reg-run.adoc[]
* xref:flex-local-reg-run.adoc[]
* xref:flex-conn-manage.adoc[]
* xref:flex-local-manage.adoc[]
* xref:policies::policies-included-directory.adoc[]
