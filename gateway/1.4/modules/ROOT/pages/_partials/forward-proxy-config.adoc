//tag::configuration[]
A forward proxy, such as Squid, enables you to route all external Flex Gateway connections through a single proxy connection.  

For both Connected Mode and Local Mode, you configure a forward proxy using YAML configuration files.

The following diagram demonstrates how an internal network communicates with an external network using a forward proxy. 

image:forward-proxy-diagram.png[align=center]

As in the diagram, when using a forward proxy, all communication into or out of your internal network travels through the forward proxy first. 

In the previous example, all API upstream communication must also pass through the forward proxy. For more information about how to enable some connections to communicate directly, without the forward proxy, see <<noproxy-parameter, noProxy Parameter>>.

== Forward Proxy Connections
Only HTTP and HTTPS connections route through the forward proxy.

The following connections route through the forward proxy:

* Connections to Anypoint Platform
* Outbound policy connections
* Connections to upstream services
* HTTP log connections

Using the `noProxy` parameter you can configure HTTP and HTTPS connections to connect directely without using the forward proxy.

Configuring a forward proxy does not alter these connections:

* Connections to shared storage
* Lightweight Directory Access Protocol (LDAP) connections
* Transition Control Protocol (TCP) connections
* Non-HTTP log connections

== noProxy Parameter

Adding the `noProxy` parameter allows services you trust to communicate without using the forward proxy.

For example, when you enable `noProxy`, you can list connections to upstream services and HTTP log connections to connect directely to Flex Gateway. 

When using the `noProxy` parameter in the YAML configuration file, you must list the exact domain names of all domains to connect directely. You cannot list the domain suffix, for example, `.svc.cluster.local`. You need to list full domain name, `fluentd.svc.cluster.local`, for all `noProxy` connections.

You can also skip adding the `noProxy` parameter to your configuration file and add the `--no-proxy` flag during registration. Using the `--no-proxy`, you do not need to list exact domain names. To learn more about the `--no-proxy` flag, see <<forward-proxy-flex-gateway-registration, Forward Proxy Flex Gateway Registration>>.

The following diagram demonstrates the differences in communication using noProxy:

image:no-proxy-diagram.png[align=center]

In the diagram, when you do not enable `noProxy`, Flex Gateway communicates with the internal API endpoint using the forward proxy. When you do enable `noProxy`, listing the API Upstream domain, Flex Gateway communicates directly with the internal API endpoint.



== Configuring Forward Proxy Parameters

[source,yaml]
----
apiVersion: gateway.mulesoft.com/v1alpha1
kind: Configuration
metadata:
  name: forward-proxy
spec:
  forwardProxy: 
    https: // REQUIRED
      address: http://proxy:8888 // REQUIRED
      basicAuth: // OPTIONAL
        username: <string> // OPTIONAL
        Password: <string> // OPTIONAL
    noProxy: // OPTIONAL
       - fluentd.svc.cluster.local

----

|===
|Parameter | Required or Optional | Description

| `https.address`
| required
| Proxy adddress

| `basicAuth`
| Optional
| Supplies authentication username and password

| `basicAuth.username`
| Optional
| Authentication username

| `basicAuth.Password`
| Optional
| Authentication password

| `noProxy`
| Optional
| Array containing domain names to communicate to without using the forward proxy
|===


== File Configuration Example

. Create a YAML configuration file in the Flex Gateway configuration directory:
+
[source,ssh]
----
sudo touch /usr/local/share/mulesoft/flex-gateway/conf.d/forward-proxy.yaml
----

. Update the file with your TLS context configuration details. For example:
+
[source,ssh]
----
sudo vi /usr/local/share/mulesoft/flex-gateway/conf.d/forward-proxy.yaml
----
+
*Sample configuration for adding a forward proxy:*
+
[source,yaml]
----
apiVersion: gateway.mulesoft.com/v1alpha1
kind: Configuration
metadata:
  name: forward-proxy
spec:
  forwardProxy:
    https:
      address: http://proxy:8888
      basicAuth: // OPTIONAL
        username: "username"
        Password: "password"
    noProxy: // OPTIONAL
      - fluentd

----

//end::configuration[]

//tag:localRegistration[]

== Forward Proxy Flex Gateway Registration
You must add additional registration flags when xref:flex-local-reg-run.adoc[registering a Flex Gateway in Local Mode].

You must add the `--https-proxy` flag using your proxy `address` parameter:
[source,ssh]
----
--https-proxy=http://proxy:8888
----

Provide your `username` and `password` parameters if you enable `basicAuth`:
[source,ssh]
----
--https-proxy=http://<username>:<password>@proxy:8888
----

Provide the `--no-proxy` flag when registering your Flex Gateway when enabling `noProxy` without the YAML Conifguration file:
[source,ssh]
----
--no-proxy=.svc.cluster.local
----
You can list partial domain names using the `--no-proxy` flag.


The following sample registration command shows flag placement:
[source,ssh]
----
flexctl register \
--username=<your-username> \
--password=<your-password> \
--environment=<your-environment-id> \
--organization=<your-org-id> \
--output-directory=/usr/local/share/mulesoft/flex-gateway/conf.d \
--https-proxy=http://<username>:<password>@proxy:8888 \ 
--no-proxy=.svc.cluster.local \
my-gateway
----

//end:localRegistration[]


//tag:connRegistration[]

== Forward Proxy Flex Gateway Registration
You must add additional registration flags when xref:flex-conn-reg-run.adoc[registering a Flex Gateway in Connected Mode].

You must add the `--https-proxy` flag using your proxy `address` parameter:
[source,ssh]
----
--https-proxy=http://proxy:8888
----

Provide your `username` and `password` parameters if you enable `basicAuth`:
[source,ssh]
----
--https-proxy=http://<username>:<password>@proxy:8888
----

Provide the `--no-proxy` flag when registering your Flex Gateway is enabling `noProxy`:
[source,ssh]
----
--no-proxy=fluentd
----

The following sample registration command shows flag placement:
[source,ssh]
----
flexctl register \
--username=<your-username> \
--password=<your-password> \
--environment=<your-environment-id> \
--organization=<your-org-id> \
--output-directory=/usr/local/share/mulesoft/flex-gateway/conf.d \
--https-proxy=http://<username>:<password>@proxy:8888 \ 
--no-proxy=fluentd \
my-gateway
----

//end:connRegistration[]