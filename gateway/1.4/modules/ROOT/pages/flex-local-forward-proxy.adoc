= Configuring a Forward Proxy for Flex Gateway in Local Mode
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../assets/images

A Forward Proxy allows you to route all Flex Gateway connections through a single proxy connection. This allows you to isolate Flex Gateways to an internal network. For both Connected Mode and Local Mode, you configure a forward proxy YAML configuration files. 

The following diagram demonstrates how an internal network communicates with an external network using a forward proxy. In the diagram, all communication from the internal Flex Gateway replicas travel through the forward proxy, then to Anypoint Platfrom. Communication from Anypoint Platform travels through the firewall first, then the forward proxy, before reaching the Flex Gateway replica.

image:forward-proxy-diagram.png[width=85%]

== Configuring Forward Proxy Parameters

[source,yaml]
----
apiVersion: gateway.mulesoft.com/v1alpha1
kind: Configuration
metadata:
  name: forward-proxy
spec:
  forwardProxy: 
    https: // REQUIRED
      address: http://proxy:8888 // REQUIRED
      basicAuth: // OPTIONAL
        username: <string> // OPTIONAL
        Password: <string> // OPTIONAL
    noProxy: // OPTIONAL
       - fluentd // OPTIONAL

----

|===
|Parameter | Required or Optional | Description

| `https.address`
| required
| Proxy adddress

| `basicAuth`
| Optional
| Supplies authentication username and password

| `basicAuth.username`
| Optional
| Authentication username

| `basicAuth.Password`
| Optional
| Authentication password

| `noProxy`
| Optional
| Allows internal network connections to communicate without proxy
|===

Adding the `noProxy` parameter allows services inside the trusted internal network to communicate without using the proxy.




== File Configuration Example

. Create a YAML configuration file in the Flex Gateway configuration directory:
+
[source,ssh]
----
sudo touch /usr/local/share/mulesoft/flex-gateway/conf.d/forward-proxy.yaml
----

. Update the file with your TLS context configuration details. For example:
+
[source,ssh]
----
sudo vi /usr/local/share/mulesoft/flex-gateway/conf.d/forward-proxy.yaml
----
+
*Sample configuration for adding a forward proxy:*
+
[source,yaml]
----
apiVersion: gateway.mulesoft.com/v1alpha1
kind: Configuration
metadata:
  name: forward-proxy
spec:
  forwardProxy:
    https:
      address: http://proxy:8888
      basicAuth:
        username: "username"
        Password: "password"
    noProxy:
      - fluentd

----




















Anypoint Flex Gateway enables you to deliver metrics to any supported Fluentbit {fluentbit-ver-var} output. Refer to the xref:flex-local-configuration-reference-guide.adoc#logging[Declarative Configuration Reference Guide] for information on how to configure Flex Gateway for any of these supported outputs.

The following examples describe how to configure Flex Gateway for use with the File and HTTP outputs.


== File Configuration Example

Configure Flex Gateway

Configure Flex Gateway to send formatted runtime and access logs to a file called `log.txt` (Fluentbit `File` output), located within `/var/log` directory. As an example, the following definition specifies a `spec.logging.outputs.type` value of `file`:

NOTE: For Docker, in `spec.logging.output.parameters.file`, replace `/var/log` with the absolute path to the mounted configuration directory.

----
apiVersion: gateway.mulesoft.com/v1alpha1
kind: Configuration
metadata:
  name: logging-config
spec:
  logging:
    outputs:
    - name: default
      type: file
      parameters:
        file: /var/log/log.txt # Docker: replace `/var/log` with the absolute path to the mounted configuration directory
        format: template
        template: |
          [{logger}][{level}][{kind}] {message}
    runtimeLogs:
      logLevel: info
      outputs:
      - default
    accessLogs:
      outputs:
      - default
----

== HTTP Configuration Example

In addition to configuring logging for Fluentbit `File` output, you can also configure for Fluentbit `HTTP` output. As an example, the following definition specifies a `spec.logging.outputs.type` value of `http`:

----
apiVersion: gateway.mulesoft.com/v1alpha1
kind: Configuration
metadata:
  name: logging-config
spec:
  logging:
    outputs:
    - name: default
      type: http
      parameters:
        host: collectors.au.sumologic.com
        port: "443"
        URI: /receiver/v1/http/[PrivateKey]
        format: json_lines
        json_date_key: timestamp
        json_date_format: iso8601
    runtimeLogs:
      logLevel: info
      outputs:
      - default
    accessLogs:
      outputs:
      - default
----

[[access-logs]]
== Access Logs

After specifying access log output (as described in the previous configuration examples), you must enable access logs via policy binding. 

For inline configurations, enable access logs by adding `message-logging-flex` to the `spec.policies` section of `ApiInstance`. The following is an inline configuration example:

----
apiVersion: gateway.mulesoft.com/v1alpha1
kind: ApiInstance
metadata:
  name: jsonplaceholder-api
spec:
  address: http://0.0.0.0:8080
  services:
    jsonplaceholder:
      address: https://jsonplaceholder.typicode.com:443/
      routes:
        - rules:
            - path: /api(/users/.*)
  policies:
    - policyRef:
        name: message-logging-flex
      config:
        loggingConfiguration:
          - itemName: "Access Log Request"
            itemData:
              message: "#[attributes.version ++ ' ' ++ attributes.method ++ ' ' ++ attributes.requestUri]"
              level: "INFO"
              firstSection: true
          - itemName: "Access Log Response"
            itemData:
              message: "#[attributes.statusCode ++ ' ' ++ (attributes.headers['content-length'] default '')]"
              level: "INFO"
              secondSection: true
----

For resource-based configurations, enable access logs by adding `message-logging-flex` to the `spec.policyRef` section of `PolicyBinding`. The following is a resource-based configuration example:

----
apiVersion: gateway.mulesoft.com/v1alpha1
kind: PolicyBinding
metadata:
  name: ingress-http-access-logs
spec:
  targetRef:
    kind: ApiInstance
    name: ingress-http
  policyRef:
    kind: Extension
    name: message-logging-flex
  config:
    loggingConfiguration:
      - itemName: "Access Log Request"
        itemData:
          message: "#[attributes.version ++ ' ' ++ attributes.method ++ ' ' ++ attributes.requestUri]"
          level: "INFO"
          firstSection: true
      - itemName: "Access Log Response"
        itemData:
          message: "#[attributes.statusCode ++ ' ' ++ (attributes.headers['content-length'] default '')]"
          level: "INFO"
          secondSection: true
----
