= Getting Started with Local Mode
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../assets/images

Install Flex Gateway as a Kubernetes Ingress Controller, as a Linux Service, or using Docker. You can then immediately start applying out-of-the-box policies to APIs, via declarative configuration files. The following procedures demonstrate installing Flex Gateway, deploying an example proxy API, and securing the API with a basic authentication policy.

[cols="1,1,1"]
|===

|image:install-linux-logo.png[20%,20%,xref="flex-local-installing-running.adoc#install-and-run-as-a-linux-service"]

|image:install-docker-logo.png[25%,25%,xref="flex-local-installing-running.adoc#install-and-run-using-docker"]

|image:install-kubernetes-logo.png[20%,20%,xref="flex-local-installing-running.adoc#install-and-run-as-a-kubernetes-ingress-controller"]

|xref:flex-local-installing-running.adoc#install-and-run-as-a-linux-service[Install and Run as a Linux Service]

|xref:flex-local-installing-running.adoc#install-and-run-using-docker[Install and Run using Docker]

|xref:flex-local-installing-running.adoc#install-and-run-as-a-kubernetes-ingress-controller[Install and Run as a Kubernetes Ingress Controller]

|===

== Install and Run as a Linux Service

The following procedure demonstrates how to install and run Flex Gateway as a service on a Debian-based distribution.

. Retrieve the public package keys, add the package repository, update the package list, and install the package via the commands in the following block: 
+
----
curl -XGET https://peregrine:48bcfd4617c9cce@d8wbbsqfcfi8u.cloudfront.net/ubuntu/pubkey.gpg | sudo apt-key add -
echo "deb https://peregrine:48bcfd4617c9cce@d8wbbsqfcfi8u.cloudfront.net/ubuntu $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/mulesoft.list
sudo apt update
sudo apt install -y peregrine
----

. Run Flex Gateway by executing the following command:
+
----
sudo service peregrine start
----

. Verify that the Flex Gateway service is running successfully by executing the following command: 
+
----
service --status-all
----
+
A list of all services displays. Locate the `peregrine` service, which will be successfully running if the value of its `status` is `+`, as in the following:   
+
----
[ + ]  peregrine
----

. Create a configuration file called `app.yaml` and save it in the Flex Gateway configuration directory: `/etc/peregrine/conf.d/custom/`. This directory can contain multiple configuration files.

. Copy and paste the following into `app.yaml`, then save:
+
----
apiVersion: gateway.mulesoft.com/v1alpha1
kind: ApiInstance
metadata:
  name: jsonplaceholder-api
spec:
  address: http://0.0.0.0:8080
  services:
    jsonplaceholder:
      address: https://jsonplaceholder.typicode.com:443/
      routes:
        - rules:
            - path: /api(/users/.*)
            - path: /api(/comments/.*)
  policies:
    - policyRef:
        name: basic-authentication
      config:
        username: foo
        password: bar
----
+
The configuration creates a service called `jsonplaceholder`, specifies its implementation address, and then defines path rules.
+
Additionally, the configuration applies a policy called `basic-authentication`, and specifies credentials that incoming requests use when accessing the `jsonplaceholder` service.

. Verify that the API is protected by requesting access without the authentication credentials:
+
----
curl -v http://127.0.0.1:8080/api/users/1
---- 
+
The result includes the following: 
+
----
HTTP/1.1 401 Unauthorized
----

. Verify that the API returns correct data when authentication credentials are included: 
+
----
curl -v -u foo:bar http://127.0.0.1:8080/api/users/1
----
+
The result should include the following: 
+
----
[
  {
    "id": 1,
    "name": "Leanne Graham",
    "username": "Bret",
    "email": "Sincere@april.biz",
    "address": {
      "street": "Kulas Light",
      "suite": "Apt. 556",
      "city": "Gwenborough",
      "zipcode": "92998-3874",
      "geo": {
        "lat": "-37.3159",
        "lng": "81.1496"
      }
    },
    "phone": "1-770-736-8031 x56442",
    "website": "hildegard.org",
    "company": {
      "name": "Romaguera-Crona",
      "catchPhrase": "Multi-layered client-server neural-net",
      "bs": "harness real-time e-markets"
    }
  },
  ...
----

A secured service is now running behind Flex Gateway.

=== Next Steps

* xref:flex-local-viewing-and-managing-logs.adoc[View and Manage Log Output].
* Refer to the xref:flex-local-configuration-reference-guide.adoc[Declarative Configuration Reference Guide].

== Install and Run using Docker

The following procedure demonstrates how to install and run Flex Gateway using Docker.

. Download the Flex Gateway container image by executing the following command: 
+
----
curl -o flex-gateway-1.0.0-beta.5.tar https://peregrine:48bcfd4617c9cce@d8wbbsqfcfi8u.cloudfront.net/docker/flex-gateway-1.0.0-beta.5.tar
----

. Move the container image into a directory of your choice.
. Using the command line interface, navigate to the directory containing the container image.
. Install the container image by executing the following command:
+
----
docker load --input flex-gateway-1.0.0-beta.5.tar
----

. Verify the installation was successful by executing the following command: 
+
----
docker images
----
+
The Flex Gateway container image should appear in the resulting list: 
+
----
REPOSITORY                   TAG              IMAGE ID       CREATED        SIZE
mulesoft/flex-gateway        1.0.0-beta.5     1c1fbdbf819b   9 days ago     334MB
----

. Create a configuration file called `app.yaml` (this filename can be anything) and save it in the same directory as your container image.

. Copy and paste the following into the `app.yaml` file, then save:
+
----
apiVersion: gateway.mulesoft.com/v1alpha1
kind: ApiInstance
metadata:
  name: jsonplaceholder-api
spec:
  address: http://0.0.0.0:8080
  services:
    jsonplaceholder:
      address: https://jsonplaceholder.typicode.com:443/
      routes:
        - rules:
            - path: /api(/users/.*)
            - path: /api(/comments/.*)
  policies:
    - policyRef:
        name: basic-authentication
      config:
        username: foo
        password: bar
----
+
The configuration creates a service called `jsonplaceholder`, specifies its implementation address, and then defines path rules.
+
Additionally, the configuration applies a policy called `basic-authentication`, and specifies credentials that incoming requests use when accessing the `jsonplaceholder` service.

. Run Flex Gateway by executing the following command, replacing `/absolute/path/to/configuration/directory/` with the absolute path to the configuration directory containing the `app.yaml` file created in the previous step. 
+
----
docker run -it -p 8080:8080 -v /absolute/path/to/configuration/directory/:/etc/peregrine/conf.d/custom/ mulesoft/flex-gateway:1.0.0-beta.5
----
+
In addition to running Docker, the command instructs the running instance to listen at a given port, and to mount the configuration on the image.
+
NOTE: `docker run` does not return. Open a new terminal to continue. 

. Verify that the container image is running successfully executing the following command: 
+
----
docker ps
----
+
The Flex Gateway process should appear in the resulting list: 
+
----
CONTAINER ID   IMAGE                                     COMMAND   CREATED      STATUS      PORTS                                       
c2a360f8c9ed   mulesoft/flex-gateway:1.0.0-beta.5        "/init"   8 days ago   Up 8 days   0.0.0.0:8080->8080/tcp, :::8080->8080/tcp 
----

. Verify that the service is protected by requesting access without the authentication credentials:
+
----
curl -v http://127.0.0.1:8080/api/users/1
---- 
+
The result includes the following: 
+
----
HTTP/1.1 401 Unauthorized
----

. Verify that the service returns correct data when authentication credentials are included: 
+
----
curl -v -u foo:bar http://127.0.0.1:8080/api/users/1
----
+
The result should include the following: 
+
----
[
  {
    "id": 1,
    "name": "Leanne Graham",
    "username": "Bret",
    "email": "Sincere@april.biz",
    "address": {
      "street": "Kulas Light",
      "suite": "Apt. 556",
      "city": "Gwenborough",
      "zipcode": "92998-3874",
      "geo": {
        "lat": "-37.3159",
        "lng": "81.1496"
      }
    },
    "phone": "1-770-736-8031 x56442",
    "website": "hildegard.org",
    "company": {
      "name": "Romaguera-Crona",
      "catchPhrase": "Multi-layered client-server neural-net",
      "bs": "harness real-time e-markets"
    }
  },
  ...
----

A secured service is now running behind Flex Gateway.

=== Next Steps

* xref:flex-local-viewing-and-managing-logs.adoc[View and Manage Log Output].
* Refer to the xref:flex-local-configuration-reference-guide.adoc[Declarative Configuration Reference Guide].

== Install and Run as a Kubernetes Ingress Controller

The following procedures demonstrate how to install and run Flex Gateway as an ingress controller.

=== Dependencies

* A tool to create Kubernetes clusters. The following examples use https://k3d.io/v5.0.0/#installation[k3d^].
* https://kubernetes.io/docs/tasks/tools/#kubectl[kubectl,^] a tool used to interact with Kubernetes clusters.
* https://helm.sh/docs/intro/install/[Helm,^] a tool used to install Flex Gateway, monitoring tools and applications. A minimum Helm version of 3.0.0 is required.

=== Prepare the Environment

. Create a new Kubernetes cluster with a single server node: 
+
----
k3d cluster create flex-gateway-1 --k3s-arg "--disable=traefik@server:*" --port '80:80@server:*' --port '443:443@server:*'
----
+
The command should return the following: 
+
----
INFO[0042] Cluster 'flex-gateway-1' created successfully!
----

. Download the Flex Gateway container image: 
+
----
curl -o flex-gateway-1.0.0-beta.5.tar https://peregrine:48bcfd4617c9cce@d8wbbsqfcfi8u.cloudfront.net/docker/flex-gateway-1.0.0-beta.5.tar
----

. Import the container image: 
+
----
k3d image import -c flex-gateway-1 flex-gateway-1.0.0-beta.5.tar
----
+
The command should return the following: 
+
----
INFO[0016] Successfully imported image(s)
INFO[0016] Successfully imported 1 image(s) into 1 cluster(s)
----

=== Procedure 

. Add the helm repository: 
+
----
helm repo add flex-gateway https://peregrine:48bcfd4617c9cce@d8wbbsqfcfi8u.cloudfront.net/helm
----

. Update the helm repository:
+
----
helm repo up
----

. Install the *flex-gateway* helm chart into namespace *gateway* with ingress:  
+
----
helm -n gateway upgrade -i --wait --create-namespace ingress flex-gateway/flex-gateway
----
+
The command should return something like the following: 
+
----
NAME: ingress
LAST DEPLOYED: Tue Oct 19 13:08:07 2021
NAMESPACE: gateway
STATUS: deployed
REVISION: 1
TEST SUITE: None
----

. Execute the following command to verify *apiinstances* created during installation: 
+
----
kubectl -n gateway get apiinstances
---- 
+
The command returns output similar to the following: 
+
----
NAME            ADDRESS
ingress-http    http://0.0.0.0:80
ingress-https   http://0.0.0.0:443
----

. Install a sample application named "jsonplaceholder", and create the ingress to route traffic: 
+
----
cat <<EOF | kubectl apply -f -
---
apiVersion: v1
kind: Service
metadata:
  name: jsonplaceholder
  labels:
    app: jsonplaceholder
    service: jsonplaceholder
spec:
  ports:
  - name: http
    port: 80
    targetPort: http
  selector:
    app: jsonplaceholder
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: jsonplaceholder
spec:
  replicas: 1
  selector:
    matchLabels:
      app: jsonplaceholder
      version: v1
  template:
    metadata:
      labels:
        app: jsonplaceholder
        version: v1
    spec:
      containers:
      - image: svenwal/jsonplaceholder
        imagePullPolicy: IfNotPresent
        name: jsonplaceholder
        ports:
        - name: http
          containerPort: 3000
        resources:
          limits:
            cpu: 100m
            memory: 64Mi
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: jsonplaceholder
spec:
  ingressClassName: ingress-http.gateway
  rules:
  - http:
      paths:
      - path: /api(/users/.*)
        pathType: ImplementationSpecific
        backend:
          service:
            name: jsonplaceholder
            port:
              number: 80
EOF
----

. Apply the *basic-authentication* policy to the `ingress-http` API Instance, using `foo` as the username and `bar` as the password
+
----
cat <<EOF | kubectl -n gateway apply -f -
---
apiVersion: gateway.mulesoft.com/v1alpha1
kind: PolicyBinding
metadata:
  name: ingress-http-auth
spec:
  targetRef:
    name: ingress-http
  policyRef:
    name: basic-authentication
  config:
    username: foo
    password: bar
EOF
----

. Verify that the API Instance is protected by requesting access without the authentication credentials:
+
----
curl -v http://127.0.0.1/api/users/1
---- 
+
The result includes the following: 
+
----
HTTP/1.1 401 Unauthorized
----

. Verify that the API Instance returns correct data when authentication credentials are included: 
+
----
curl -v -u foo:bar http://127.0.0.1/api/users/1
----
+
The result should include the following: 
+
----
[
  {
    "id": 1,
    "name": "Leanne Graham",
    "username": "Bret",
    "email": "Sincere@april.biz",
    "address": {
      "street": "Kulas Light",
      "suite": "Apt. 556",
      "city": "Gwenborough",
      "zipcode": "92998-3874",
      "geo": {
        "lat": "-37.3159",
        "lng": "81.1496"
      }
    },
    "phone": "1-770-736-8031 x56442",
    "website": "hildegard.org",
    "company": {
      "name": "Romaguera-Crona",
      "catchPhrase": "Multi-layered client-server neural-net",
      "bs": "harness real-time e-markets"
    }
  },
  ...
----

A secured service is now running behind Flex Gateway.

=== Next Steps

* xref:flex-local-viewing-and-managing-logs.adoc[View and Manage Log Output].
* Refer to the xref:flex-local-configuration-reference-guide.adoc[Declarative Configuration Reference Guide].