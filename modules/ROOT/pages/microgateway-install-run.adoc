= Install and Run Flex Gateway
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:imagesdir: ../assets/images

Flex Gateway runs in many different environments, including Docker, Ubuntu, and Kubernetes (as an application and as an ingress controller). This document describes how to install and run Flex Gateway in each of these environments.

[cols="1,1,1,1"]
|===

|image:install-docker-logo.png[25%,25%,xref="microgateway-install-run.adoc#install-and-run-as-a-docker-container-image"]

|image:install-ubuntu-logo.png[20%,20%,xref="microgateway-install-run.adoc#install-and-run-as-an-ubuntu-service"]

|image:install-kubernetes-logo.png[20%,20%,xref="microgateway-install-run.adoc#install-and-run-as-a-kubernetes-application"]

|image:install-kubernetes-logo.png[20%,20%,xref="microgateway-install-run.adoc#install-and-run-as-a-kubernetes-ingress-controller"]

|xref:microgateway-install-run.adoc#install-and-run-as-a-docker-container-image[Install and Run as a Docker Container Image]

|xref:microgateway-install-run.adoc#install-and-run-as-an-ubuntu-service[Install and Run as an Ubuntu Service in a VM]

|xref:microgateway-install-run.adoc#install-and-run-as-a-kubernetes-application[Install and Run as a Kubernetes Application]

|xref:microgateway-install-run.adoc#install-and-run-as-a-kubernetes-ingress-controller[Install and Run as a Kubernetes Ingress Controller]

|===

== Install and Run as a Docker Container Image

A Docker container image is a package of software that includes everything needed to run an application. You install and run Flex Gateway as a container image in your local environment during application development - enabling you to test and iterate quickly within Continuous-Integration and Continuous Delivery (CI/CD) workflows. 

The following procedure demonstrates how to install and run a "containerized" Flex Gateway in your local environment.

=== Before You Begin

Installation requires a Docker-enabled environment with appropriate Docker permissions.

=== Procedure

. https://drive.google.com/file/d/1xR2kQqV5BUdIqk8LUbdW8LSdjlF2dP8P/view?usp=sharing[Download the Flex Gateway container image^].
. Copy the container image tar archive into a directory of your choice.
. Open a command line client and navigate to the directory containing the container image tar archive.
. Load ("install") the Flex Gateway container image by executing the following command:
+
----
docker load --input anypoint-flex-gateway.tar
----

. Verify the installation was successful by executing the following command: 
+
----
docker images
----
+
The Flex Gateway container image should appear in the resulting list: 
+
----
REPOSITORY                                TAG       IMAGE ID       CREATED        SIZE
mulesoft/anypoint-flex-gateway            latest    1c1fbdbf819b   9 days ago     279MB
----

. https://drive.google.com/file/d/1Uq1YA8UZCRCLhmg7-nMsUPjafNjFzAPQ/view?usp=sharing[Download the sample Flex Gateway configuration file^].
. Copy the sample configuration `.yaml` file into a directory of your choice (typically the same directory as the container image tar archive.)
. Run the Flex Gateway by executing the following command: 
+
----
docker run -it -p 8080:8080 -v /absolute/path/to/sample/config.yaml:/etc/peregrine/conf.d/custom/config.yaml mulesoft/anypoint-flex-gateway
----

. Verify that the container image is running successfully by executing the following command: 
+
----
docker ps
----
+
The Flex Gateway process should appear in the resulting list: 
+
----
CONTAINER ID   IMAGE                            COMMAND   CREATED      STATUS      PORTS                                       
c2a360f8c9ed   mulesoft/anypoint-flex-gateway   "/init"   8 days ago   Up 8 days   0.0.0.0:8080->8080/tcp, :::8080->8080/tcp 
----

== Install and Run as an Ubuntu Service

In addition to sandboxing Flex Gateway as a Docker container image, you can install and run Flex Gateway as an Ubuntu service. The Ubuntu instance is typically run virtually as a node in a virtual machine cluster, thereby guaranteeing that each virtual machine (with its running Flex Gateway) is standalone and encapsulated. 

The following procedure demonstrates how to install and run Flex Gateway as a service in an Ubuntu instance.

=== Procedure

. Retrieve the public package keys and add them to the Advanced Package Tool (APT) key server by executing the following command:
+ 
----
wget -qO- https://peregrine-repos.s3.us-west-2.amazonaws.com/ubuntu/pubkey.gpg | sudo apt-key add -
----

. Add the Flex Gateway package repository by storing the type of distribution archive (Debian), as well as the repository URL and Ubuntu distribution code name. Execute the following command: 
+
----
echo "deb https://peregrine-repos.s3.us-west-2.amazonaws.com/ubuntu $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/mulesoft.list
----

. Update the package list by executing the following command: 
+
----
sudo apt update
----

. Install the Flex Gateway package from the updated repository by executing the following command:
+
----
sudo apt install anypoint-flex-gateway
----

. Run the Flex Gateway by executing the following command:
+
----
sudo service anypoint-flex-gateway start
----

. Verify that the Flex Gateway service is running successfully by executing the following command: 
+
----
service --status-all
----
+
A list of all services displays. Locate the `anypoint-flex-gateway` service, which will be successfully running if the value of its `status` is `+`, as in the following:   
+
----
[ + ]  anypoint-flex-gateway
----

== Install and Run as a Kubernetes Application

The following procedure demonstrates how to install and run Flex Gateway as an application running in a Kubernetes cluster.

=== Procedure

. Configure your network to support Flex Gateway on Kubernetes.
+
The following ports must be configured correctly:
+
[%header%autowidth.spread]
|===
| Port | Layer 4 Protocol | Layer 5 Protocol | Source | Destination | Description
| x | TCP | HTTPS | Internet | All nodes | Allow inbound requests to Flex Gateway
| x | TCP | x | All nodes | Internet | x
| x | TCP | x | All nodes | Internet | x
|===
+
The following hostnames must be configured correctly:
+
[%header,cols="4*a"]
|===
| Port | Protocol | Hostnames | Description
| x | x | x | x
| x | x | x | x
| x | x | x | x
|===

. Install Flex Gateway.
+
You can execute `docker load` and then `docker push` to a registry (you can host a private registry in Kubernetes or use a public one).

. Run Flex Gateway:
+
----
kubectl create deployment <...>
----

. Verify that the Flex Gateway service is running successfully. 
.. View the deployment: 
+
----
kubectl get deployments
----
+
The output is similar to: 
+
----
NAME                    READY   UP-TO-DATE   AVAILABLE   AGE
anypoint-flex-gateway   1/1     1            1           1m
----
+
.. View the Pod: 
+
----
kubectl get pods <...>
----
+
The output is similar to: 
+
----
NAME                                     READY     STATUS    RESTARTS   AGE
anypoint-flex-gateway-5f76cf6ccf-br9b5   1/1       Running   0          1m
----

== Install and Run as a Kubernetes Ingress Controller

The following procedure demonstrates how to install and run Flex Gateway as a Kubernetes Ingress controller.

=== Procedure

. Configure your network to support Flex Gateway on Kubernetes.
+
The following ports must be configured correctly:
+
[%header%autowidth.spread]
|===
| Port | Layer 4 Protocol | Layer 5 Protocol | Source | Destination | Description
| x | TCP | HTTPS | Internet | All nodes | Allow inbound requests to Flex Gateway
| x | TCP | x | All nodes | Internet | x
| x | TCP | x | All nodes | Internet | x
|===
+
The following hostnames must be configured correctly:
+
[%header,cols="4*a"]
|===
| Port | Protocol | Hostnames | Description
| x | x | x | x
| x | x | x | x
| x | x | x | x
|===

. Install Flex Gateway as an Ingress by executing the following commands: 
+
----
helm add repo <peregrine-helm-chart-repo-uri>
helm install -n <namespace> --atomic mgw-peregrine mgw-peregrine
----

. Verify that the Flex Gateway Ingress pod is running by executing the following: 
+
----
kubectl get pods --all-namespaces -l app=mgw-peregrine
----
+
The output is similar to: 
+
----
NAMESPACE       NAME                             READY   STATUS    RESTARTS   AGE
<namespace>     mgw-peregrine-5d55d8b9dc-v46bg   1/1     Running   0          2m14s
----

. Verify that the Flex Gateway Ingress service is running by executing the following: 
+
----
kubectl get services mgw-peregrine
----
+
The output is similar to: 
+
----
NAME            TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                      AGE
mgw-peregrine   LoadBalancer   10.21.252.165   192.168.86.11   80:30451/TCP,443:31967/TCP   47s
----

. Create a configuration file that contains the required `apiVersion`, `kind`, and `metadata` fields:
+
----
# ingress-http.apiinstance.yaml
apiVersion: gateway.mulesoft.com/v1alpha1
kind: ApiInstance
metadata:
  name: ingress-http
spec:
  address: <proxy address including port> # example: http://0.0.0.0:8080/ 
----

. Apply the configuration by executing the following command: 
+
----
kubectl -n <namespace> apply -f ingress-http.apiinstance.yaml
----

. Associate an Ingress definition with the `ApiInstance` using the `kubernetes.io/ingress.class` annotation. Create a configuration file that contains the following: 
+
----
# helloworld.ingress.yaml
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  name: helloworld
  annotations:
     kubernetes.io/ingress.class: ingress-http
spec:
  rules:
  - host: helloworld.example.com
    http:
      paths:
      - path: /
        backend:
          serviceName: helloworld
          servicePort: 5000
----

. Apply the Ingress definition configuration by executing the following command:
+
----
kubectl -n <namespace> apply -f helloworld.ingress.yaml
----