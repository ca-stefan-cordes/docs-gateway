= Getting Started with Flex Gateway on a Kubernetes Cluster
ifndef::env-site,env-github[]
include::_attributes.adoc[]
endif::[]
:version-helm: 3.0.0

Get started with Anypoint Flex Gateway on a Kubernetes cluster. Set up a Flex Gateway container that connects to Anypoint Platform in Connected Mode, and use the container to control local traffic to an API implementation. This guide covers the following high-level tasks:

* Installing, registering, deploying, and running a Flex Gateway container in Connected Mode. 
* Creating an API in Anypoint API Manager that runs on your Flex Gateway container. 
* Connecting to the API, first without any authentication, and then with a basic authentication policy that you set up for the API in API Manager. 

The Flex Gateway deployment process requires a working Kubernetes cluster that you create or that is provisioned for you by a Kubernetes professional. 

Setting up a Kubernetes cluster requires a level of skill and expertise that is _beyond the scope of this guide to provide_. Cluster configuration in Kubernetes differs markedly by service provider and platform. For basic cluster setup questions, consult documentation from your Kubernetes service provider. 

If you lack a Kubernetes cluster but want to try out Flex Gateway quickly, without creating a cluster, see xref:flex-gateway-getting-started.adoc[Getting Started with Flex Gateway] (for Docker), which does not require deployment to a cluster.

== Before You Begin

Before starting the procedures in this guide, ensure that the following prerequisites are in place:
 
* A username and password for your Anypoint Platform organization. If you don’t have Anypoint Platform yet, https://anypoint.mulesoft.com/login/signup[create a Trial organization^] on Anypoint Platform.
//TODO: VERIFY THAT Manage Servers and Read Servers permissions in Runtime Manager IS NO LONGER NEEDED

//os prereqs
* A Linux or MacOS machine with an x86 processor. M1 and M2 processors are not supported.

//docker prereq
* {empty}
include::partial$prerequisites.adoc[tag=docker]
+
Run `docker --version` from a terminal window to find out if this tool is installed. If you need to install Docker, try https://www.docker.com/[Docker Desktop^]. 

//helm prereq
* {empty}
include::partial$prerequisites.adoc[tag=helm] 
+
Run `helm version` from a terminal window to find out if this tool is installed and check the version. To install or upgrade, use the https://helm.sh/[Helm^] website. 

//kubectl prereq to select cluster prior to deployment
* {empty}
include::partial$prerequisites.adoc[tag=kubectl]
+
Run `kubectl version --output=yaml` from a terminal window to find out if this tool is installed. If not, find `kubectl` among the installation tools available through the https://kubernetes.io/docs/tasks/tools/[Kubernetes documentation^]. 

//curl prereq to test the API with flex
* {empty}
include::partial$prerequisites.adoc[tag=curl]
+
Run `curl --version` from a terminal window to find out if this tool is installed. If not, you can download it with a package manager for your machine. 

[[k8-cluster-reqs]]
== Kubernetes Cluster Requirements

The host for your Kubernetes cluster can be any xref:flex-review-prerequisites.adoc#software-requirements[supported Kubernetes provider], including common cloud-based services, such as Amazon Elastic Kubernetes Service (EKS), Azure Kubernetes Service (AKS), or Google Kubernetes Engine (GKE).

To complete the procedures in this guide, you must create a Kubernetes cluster or use an existing one for your Flex Gateway deployment. The Kubernetes cluster must contain a least one node to which you can deploy a Flex Gateway container (or replica). This guide uses Helm to deploy the container and connect it to Anypoint Platform. This process generates a Kubernetes `Service` resource of the `LoadBalancer` type by default. To avoid deployment errors, your cluster must support this process.

Instead of presenting procedures for Kubernetes cluster configuration, this guide provides a set of `kubectl` command examples to help you determine whether your cluster is ready for deployment. See <<check-cluster>> before attempting the other procedures in the guide.

Note that if you have an Amazon Web Service (AWS) account and the level of experience and expertise required for creating your own Kubernetes cluster, you can create an EKS cluster using https://docs.aws.amazon.com/eks/latest/userguide/create-cluster.html[Amazon EKS User Guide^]. The AWS Management Console provides a way to create the EKS cluster, set up users and permissions, and configure node groups on dedicated virtual machines. 

[[install-flex]]
== Step 1: Install Flex Gateway

Use Docker to install the Flex Gateway Docker image.

. Start your Docker application.
. Run the following command in a terminal window:
+
[source,docker,subs=attributes+]
----
docker pull mulesoft/flex-gateway:{gateway-ver-var}
----
+
When successful, this command prints a message similar to this one in your terminal window:
+
----
latest: Pulling from mulesoft/flex-gateway
Digest: sha256:e55555abcdefg1234567zxynwo33333fadjf
Status: Image is up to date for mulesoft/flex-gateway:latest
docker.io/mulesoft/flex-gateway:latest
----
+
Use `sudo` if you encounter file permission issues when running this command. 

[[register-flex]]
== Step 2: Register Flex Gateway

Register the Flex Gateway image from a terminal window using a temporary token generated by Anypoint Runtime Manager. This procedure produces a local `registration.yaml` file that contains registration properties for a Flex Gateway container with a name that you provide. You incorporate these properties into a Helm chart when you deploy the Flex Gateway container into your cluster and connect the container to Anypoint Platform.

. From a terminal window, prepare a directory for a Flex Gateway registration file (`registration.yaml`).
.. Create a directory:
+
[source,mkdir]
----
mkdir flex-registration
----
.. Navigate to the new directory:
+
[source,cd]
----
cd flex-registration
----

. Log in to https://anypoint.mulesoft.com/login/[Anypoint Platform^] and select *Runtime Manager*.
. From Runtime Manager, locate the procedure for registering Flex Gateway:
.. Click *Flex Gateways* in the side navigation panel.
.. Click *Add Gateway*.
.. Select *Kubernetes*.
.. In the Kubernetes page, locate the command in the *Register your gateway* section:
+
image::gateway-quickstart-k8-add-gateway-rtm.png["Add registration code block from Add a Flex Gateway page"]
+
The highlighted command block includes your unique organization ID and a temporary token. 

. In your terminal window, copy the command block into your `/flex-registration` directory, and provide a name for your Flex Gateway container before running the command: 
.. In the copied command, notice `<gateway-name>` at the end of the command block, and replace that text with a name of your choice, such as `my-gateway`, for example:
+
[source,docker]
----
docker run --entrypoint flexctl -u $UID \
>   -v "$(pwd)":/registration mulesoft/flex-gateway \
>   register --organization=_ORG_ID_HERE_ \
>   --token=_TOKEN_VALUE_HERE_ \
>   --output-directory=/registration \
>   --connected=true \
>   my-gateway
----
+
Runtime Manager provides the required organization and token values.

.. Run the edited command from your terminal window.
+
When successful, the command produces a `registration.yaml` in your `/flex-registration` directory and provides the following message in your terminal window:
+
----
Starting registration, please be patient.
Registration completed, the configuration files were written 
in directory "/registration". For security, modify the file permissions 
to restrict production scenario access to the user running flex.
----
+
Note that the message in the terminal window refers to a `/registration` directory that resides within the Docker container. 
+
Use `sudo` if you encounter file permission issues when running this command. If your token expires before you run the command, a `400 Bad Request` error occurs, so you need to refresh the Runtime Manager page to generate a new token and run the modified command that appears on the page.

[[create-repo]]
== Step 3: Create a Repository for the Helm Chart

Add and update a local repository that stores a Helm chart with your Flex Gateway container's configuration. Note that you can get more information about the properties of the Helm chart for Flex Gateway in https://artifacthub.io/packages/helm/flex-gateway/flex-gateway[ArtifactHUB^].

. Create a Helm repository named `flex-gateway` for your Helm chart: 
+
[source,helm]
----
helm repo add flex-gateway https://flex-packages.anypoint.mulesoft.com/helm
----
+
The command either creates a repository or skips the repository creation process if a Helm repository with that name exists already:
+
* If the repository is new, the command returns the following message:
+
----
"flex-gateway" has been added to your repositories
----
+
* If the repository exists already, the command returns the following message:
+
----
"flex-gateway" already exists with the same configuration, skipping
----

. Run `helm repo up`.
+
The command returns the following message:
+
----
Hang tight while we grab the latest from your chart repositories...
...Successfully got an update from the "flex-gateway" chart repository
Update Complete. ⎈Happy Helming!⎈
----
+
If you have more than one Helm repository on your machine, the message in your terminal window lists all of them.

[[deploy-flex]]
== Step 4: Deploy and Connect Flex Gateway

Use Helm to deploy a Flex Gateway container to a node in your cluster and connect it to Anypoint Platform. After deploying, use Runtime Manager to verify that the container is present and connected to Anypoint Platform. 

Before you begin, confirm that your Kubernetes cluster is available by following the steps in <<check-cluster>>, and review <<k8-cluster-reqs>> if you have not done so already. These prerequisites help avoid deployment errors. 

After confirming that your Kubernetes cluster is ready, complete the following steps:

. Run the Helm command for deploying your Flex Gateway container and connecting it to Anypoint Platform. 
+
[source,helm]
----
helm -n gateway upgrade -i --create-namespace \
--wait ingress flex-gateway/flex-gateway \ 
--set-file registration.content=registration.yaml
----
+
This command creates the `gateway` namespace and `ingress` if they do not exist, and it creates or updates the `flex-gateway` Helm chart in the `flex-gateway` Helm repo. The command syntax for the Helm repository and chart names is `<helm-repo-name>/<helm-chart-name>`. 
+
When successful, the following occurs:
+
* The command prints a message indicating an upgrade to your `ingress` release:
+
----
Release "ingress" has been upgraded. Happy Helming!
NAME: ingress
LAST DEPLOYED: Mon Mar 13 22:44:11 2023
NAMESPACE: gateway
STATUS: deployed
REVISION: 1
TEST SUITE: None
----
+
The REVISION increments by `1` each time you run this command with the same namespace, repository, and chart names. For example, if you run the command a second time, you find a new revision number (`REVISION: 2`). The `LAST DEPLOYED` date reflects the date of that revision. 

* A new Flex Gateway container is running in your terminal window.
+
The container runs until you stop the process or close the terminal window in which it is running.

. Return to Runtime Manager: 
.. Select *&#8592; Flex Gateways* from the side navigation panel of the Kubernetes *Add a Flex Gateway* page. 
+
image::gateway-quickstart-k8-return-to-gateway-list.png["Return to Flex Gateway container list in Runtime Manager"]
.. Navigate to your registered container in the *Flex Gateways* page that opens:
+
image::gateway-quickstart-k8-my-gateway-rtm.png["Flex Gateway container my-gateway in Runtime Manager"]
+
You can use the search field in the page to narrow the list of containers.
+
Make sure that the status *Connected*. 
+
If the status is *Disconnected*, it is likely that the cluster configuration is incorrect. This issue can occur, for example, if the `helm -n gateway upgrade` times out before an `ingress` is created or if the cluster is misconfigured. Check <<troubleshooting>> for more information. 


//TODO: ADAPT STEP 5 AS NEEDED FOR K8, IN PROGRESS
[[create-api]]
== Step 5: Publish and Deploy a Simple API to Your Flex Gateway Container

Create and deploy a simple API to your Flex Gateway container in Anypoint API Manager. 

. In Runtime Manager, click the *View APIs* menu option for your container to navigate to the container's *View APIs* page.
+
image::gateway-quickstart-k8-view-apis.png["View APIs menu item for a Flex Gateway container"]
+
Alternatively, you can navigate to API Manager from the Anypoint Platform menu.
//TODO: FIX IMAGE lists my-gw... not my-gateway
. From the page that opens, click *Add API* (and if present, *Add new API*) to navigate to the *APIs / Add API* page in API Manager.
+
image::gateway-quickstart-k8-select-gateway-for-api.png["Add API page with Flex Gateway Runtime and my-gateway selected"]
. Work through the API configuration pages (*Runtime*, *API*, *Endpoint*, *Review*) to provide an API:
.. From the *Runtime* page, select *Flex Gateway* as your runtime.
.. In the *Select a gateway* area of the page, select your registered gateway.
+
You can use the search field to locate it, if necessary.
.. Click *Next* to open the *API* page.
. In the *API* page, set up an endpoint for your API.
+
image::gateway-quickstart-select-endpoint.png["Screenshot of 'Endpoint' page",width=100%]
+
.. In *Runtime* configuration page, click *Create an API*.
.. Specify an API name, such as *my-api*.
.. Select *HTTP API* as the asset type.
.. Click *Next*.
.. From the *Endpoint* page that opens, copy the following URI into the *Implementation URI* field:
+
[source]
----
https://jsonplaceholder.typicode.com/
----
.. Type `8081` in the *Port* field.
+
You can use any localhost port number that is available, typically `8081` through `8089`.
.. Click *Next* to 
.. Click *Save & Deploy*.
+
Inside the API instance, all HTTP requests to `localhost` on port `8081` are proxied to the `jsonplaceholder` service.
. To test the API instance, run the following command in a new terminal window:
+
[source,curl]
----
curl -s -o /dev/null -w "%{http_code}\n" --request GET 'http://localhost:8081/'
----
+
The command executes a `GET` request to the API, and then prints the resulting `200` status code, indicating success.

[NOTE]
To connect to an implementation on a remote host, you can use port `80`, get the external IP address for your API by using `kubectl -n gateway get services`, and use that IP in your `curl` command instead of using `localhost:8081`.
//TODO: LINK TO MORE DETAILS IF WE PROVIDE THIS

//TODO: ADAPT STEP 6 AS NEEDED FOR K8, IN PROGRESS
== Step 6: Secure Your API Using the Basic Authentication Policy

Add a policy to your API.

. In *API Manager*, select *API Administration* from the side navigation panel.
. Select the name of the API that you created in <<create-api>>.
. Select *Policies* from the side navigation panel.
. In the *Policies* page, click *Add policy*.
+
The following screenshot of the *Policies* page highlights the specified options:
+
image::gateway-quickstart-add-policy.png["Add Policy page with Add policy button",width=65%]

. Select the *Basic Authentication - Simple* policy.
.. Click *Next*.
.. For *User Name*, enter `user`.
.. For *User Password*, enter `password`.
.. Click *Apply*.
+
The following figure highlights the options in the *Configure Basic Authentication - Simple policy* page:
+
image::gateway-quickstart-config-basic-auth.png["Configure Basic Authentication Policy page with User Password field selected",width=65%]

. To test the API Instance _without_ authentication, run the following `curl` command in the terminal window:
+
[source,ssh]
----
curl -s -o /dev/null -w "%{http_code}\n" --request GET 'http://localhost:8081/'
----
+
The command prints a resulting `401 (Unauthorized)` status code, because the request does not include the Authentication context.
. To test the API Instance _with_ authentication, run the following command in the terminal window:
+
[source,ssh]
----
curl -s -o /dev/null -w "%{http_code}\n" --request GET 'http://localhost:8081/' -u user:password
----
+
[NOTE]
The `user` and `password` parameters must match what was specified when you applied the policy via *API Manager*.
+
The command prints the resulting `200` status code, indicating success.


[[troubleshooting]]
== Troubleshooting
//iterative troubleshooting info to add as needed:
//TODO: ADD WHAT TO DO IF THE CLUSTER APPEARS IN RTM BUT IS IN A DISCONNECTED STATE.

If you encounter an error, look for a resolution here. 

* If Docker is not started, a `docker` command returns an error message similar to this one:
+
----
Error response from daemon: Bad response from Docker engine
----
+
If you get this error, you need to start Docker.


* If you lose your connection to Anypoint Platform, the following error occurs:
+
----
[flexctl][error] reg facade call returned error response:
HTTP/1.1 400 Bad Request
----
+
If you get this error, you need to log in to Anypoint Platform. 

* If your cluster is not running when you attempt to deploy Flex Gateway using `helm`, the following error can occur:
+
----
Error: Kubernetes cluster unreachable: 
the server could not find the requested resource
----
+
You can check whether that your cluster host is running your cluster, for example:
+
[source,kubectl]
----
kubectl cluster-info
----
+
If the cluster is up, the command returns a result similar to this one:
+
----
Kubernetes control plane is running at https://34.30.50.119
GLBCDefaultBackend is running at https://34.30.50.119/api/v1/namespaces/kube-system/services/default-http-backend:http/proxy
KubeDNS is running at https://34.30.50.119/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
Metrics-server is running at https://34.30.50.119/api/v1/namespaces/kube-system/services/https:metrics-server:/proxy
----
+
If the cluster is not up, the command can return a result similar to this one:
+
----
To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
error: the server doesn't have a resource type "services"
----
+
For additional assistance, see <<check-cluster>>.

* If the Helm upgrade command fails to generate a `Service` resource of the `LoadBalancer` type, the command hangs for 5 minutes (due to the `--wait`) flag in the command and produces the following timeout error:
+
[source,error]
----
Error: UPGRADE FAILED: timed out waiting for the condition
----
+
This error typically means that your cluster configuration is incorrect or that your cluster configuration tool does not support this process. See <<k8-cluster-reqs>>.

[[check-cluster]]
=== Check Your Cluster

Before deploying a Flex Gateway container to your Kubernetes cluster, you must make sure that your cluster is ready. To check, you can use `kubectl` to list and select (use) a cluster and to get a list of nodes that the cluster uses. If any steps in this section fail, the deployment process is likely to produce errors.

To prevent potential timeout and connectivity errors when running procedures in this guide, avoid relying on simpler tools, such as minikube, to create a local cluster unless you are experienced with the tool's cluster configuration details and have the expertise necessary to make the cluster meet the <<k8-cluster-reqs>>. 

. Run `kubectl config get-contexts` to list the clusters, for example:
+
[source,kubectl]
----
kubectl config get-contexts
----
+
This command is particularly helpful if you have multiple Kubernetes clusters. You can use the command to get the name of the the correct cluster. For example, assume that you have a variety of clusters (`my-cluster`, `my-aks`, `my-gke`, `my-eks`). The command prints a list of your clusters. 
+
The following _example_ shows a list of clusters produced by the command:
+
----
CURRENT   NAME          CLUSTER       AUTHINFO    NAMESPACE
          my-cluster    my-cluster                my-cluster1
          my-aks        my-aks                    my-aks
          my-gke        my-gke                    my-gke
          my-eks        my-eks                    my-eks
----
+
If your cluster is not listed and you are using a custom cluster context file on your machine to connect to your cluster, you might need to add its path to a `KUBECONFIG` environment variable that points to that file. By default, `kubectl` searches for a file named `config` in the `$HOME/.kube` directory. That file lists each `context`, which provides properties such as the cluster name, user, and certificate authority data. 
+
You can check by running `echo $KUBECONFIG` from your terminal window, which prints a environment variable's value, similar to this example: 
+
----
{KUBECONFIG}:/Users/me/.kube/config:/Users/me/.kube/additional-clusters/my-gke:/Users/me/.kube/additional-clusters/my-aks:/Users/me/.kube/additional-clusters/my-eks
----
+
Adding the path to any additional cluster context files on your machine enables the `kubectl config get-contexts` to list them and for you to use them.
+
For more detail, see the https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/[Kubernetes documentation^] on the `kubeconfig` file. 

. Provide the name of a cluster into which you plan to deploy a Flex Gateway container.
+
The following example uses the cluster `my-eks`, identified in the cluster list: 
+
----
kubectl config use-context my-eks
----
+
The command switches to the selected cluster context and prints a message similar to this one:
+
----
Switched to context "my-eks".
----
+
If you receive an error that begins `error: no context exists with the name`, ensure you are using the `NAME` of the cluster listed by `kubectl config get-contexts` and not the `CLUSTER` value.

. Check that your cluster has one or more nodes:
+
[source,kubectl]
----
kubectl get nodes
----
+
The command returns a output similar to this example:
+
----
NAME                                           STATUS   ROLES    AGE   VERSION
ip-192-168-70-170.us-west-2.compute.internal   Ready    <none>   17h   v1.23.16-eks-48e63af
ip-192-168-9-230.us-west-2.compute.internal    Ready    <none>   17h   v1.23.16-eks-48e63af
----
+
Make sure that some node are in the `Ready` status. 
//TODO: WHAT TO DO IF NOT?
//TODO: SHOULD I REPLACE THESE REAL NAMES AND VERSIONS WITH MADE-UP ONES?
//TODO: WHAT OTHER CHARACTERISTICS SHOULD WE LOOK FOR?

. Determine your next steps:

* If your cluster is not ready, either provide one and rerun the steps in this procedure, or try the Docker-only guide, xref:flex-gateway-getting-started.adoc[].
* If you have not started the Flex setup procedures, be sure to review <<k8-cluster-reqs>> before proceeding to <<install-flex>>.
* If you have successfully completed all the procedures for installing and registering your container with Docker and creating a repository for your Helm chart, and you are ready to begin the deployment procedure, go to <<deploy-flex>>. 


== See Also

Learn other ways to set up and configure Flex Gateway for a Kubernetes cluster, and review other policy configuration options.

* xref:flex-review-prerequisites.adoc[]
* xref:flex-gateway-set-up.adoc[]
* xref:flex-gateway-configuration.adoc[]
* xref:policies::policies-included-directory.adoc[]
